---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { CATEGORIES } from "../../lib/categories";
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { resolveLocalLogo } from "../../lib/resolveLogoPath";

export async function getStaticPaths() {
  return CATEGORIES.map((cat) => ({
    params: { slug: cat.slug }
  }));
}

const { slug } = Astro.params;
const category = CATEGORIES.find((cat) => cat.slug === slug);

if (!category) {
  return Astro.redirect("/404");
}

// Load tools matching this category
const toolsDir = join(process.cwd(), "content", "tools");
const files = (await readdir(toolsDir)).filter((f) => f.endsWith(".md") && !f.startsWith("_"));

const stripMarkdown = (text: string) =>
  text
    .replace(/!\[[^\]]*]\([^)]*\)/g, "")
    .replace(/\[[^\]]*]\([^)]*\)/g, "$1")
    .replace(/[`*_>#-]/g, "")
    .replace(/\s+/g, " ")
    .trim();

const getExcerpt = (content: string) => {
  const paragraphs = content.split(/\n\s*\n/);
  for (const paragraph of paragraphs) {
    if (paragraph.trim().startsWith("#")) continue;
    const cleaned = stripMarkdown(paragraph);
    if (cleaned) return cleaned;
  }
  return "";
};

const faviconFromUrl = (url: string | null) => {
  if (!url) return null;
  try {
    const u = new URL(url);
    return `https://www.google.com/s2/favicons?sz=128&domain=${encodeURIComponent(u.hostname)}`;
  } catch {
    return null;
  }
};

const resolveCategoryIcon = (cat: string | null, tags: string[]) => {
  const normalizedCategory = cat ? cat.toLowerCase() : "";
  const normalizedTags = tags.map((tag) => tag.toLowerCase());
  const combined = [normalizedCategory, ...normalizedTags].join(" ");

  if (combined.includes("design") || combined.includes("ui") || combined.includes("ux")) {
    return "design";
  }
  if (combined.includes("automation") || combined.includes("workflow")) {
    return "automation";
  }
  if (combined.includes("ai") || combined.includes("ml") || combined.includes("machine")) {
    return "ai";
  }
  return "generic";
};

const toolsData = await Promise.all(
  files.map(async (file) => {
    const raw = await readFile(join(toolsDir, file), "utf-8");
    const { data, content } = matter(raw);
    const disabled = data.disabled === true || String(data.disabled || "").toLowerCase() === "true";
    if (disabled) return null;

    const tags = Array.isArray(data.tags) ? data.tags.map(String).map(t => t.toLowerCase()) : [];
    const matches = tags.some((tag) => category.matchTags.includes(tag));

    if (!matches) return null;

    const toolSlug = String(data.slug ?? file.replace(/\.md$/, ""));
    const title = String(data.title ?? toolSlug);
    const cat = data.category ? String(data.category) : null;
    const priceModel = data.price_model ? String(data.price_model) : null;
    const brandLogo = data.brandLogo ? String(data.brandLogo) : null;
    const providerUrl = data.affiliate_url ? String(data.affiliate_url) : data.official_url ? String(data.official_url) : null;

    const description = data.description ? String(data.description)
      : data.summary ? String(data.summary)
      : data.excerpt ? String(data.excerpt)
      : data.tagline ? String(data.tagline)
      : getExcerpt(content);

    const localLogo = resolveLocalLogo(toolSlug);
    const faviconLogo = faviconFromUrl(providerUrl);
    const iconUrl = brandLogo || localLogo || faviconLogo;
    const fallbackIcon = resolveCategoryIcon(cat, tags);

    return {
      slug: toolSlug,
      title,
      category: cat,
      priceModel,
      iconUrl,
      fallbackIcon,
      excerpt: description
    };
  })
);

const tools = toolsData.filter(Boolean);
const toolCount = tools.length;

// ── Schema.org JSON-LD ─────────────────────────────────────────────────────
const itemListSchema = {
  "@context": "https://schema.org",
  "@type": "ItemList",
  "name": category.title,
  "url": `https://tools.utildesk.de/category/${slug}/`,
  "numberOfItems": toolCount,
  "itemListElement": tools.slice(0, 200).map((t, i) => ({
    "@type": "ListItem",
    "position": i + 1,
    "name": t.title,
    "url": `https://tools.utildesk.de/tools/${t.slug}/`
  }))
};
---

<BaseLayout
  title={`${category.title} — Utildesk`}
  description={category.description}
>
  <Fragment slot="head">
    <link rel="canonical" href={`https://tools.utildesk.de/category/${slug}/`} />
    <script type="application/ld+json" set:html={JSON.stringify(itemListSchema)} />
  </Fragment>

  <div class="container">
    <section class="category-page">
      <nav class="breadcrumb">
        <a href="/category/">← Zurück zu allen Kategorien</a>
      </nav>

      <h1 class="page-title">{category.title}</h1>
      <p class="page-description">{category.description}</p>

      {category.seo && (
        <section class="category-seo">
          <div class="seo-intro" set:html={category.seo.intro.replace(/\n/g, '</p><p>')}></div>
          {category.seo.sections.map((section) => (
            <div class="seo-section">
              <h2 class="seo-section-title">{section.title}</h2>
              <p class="seo-section-text">{section.text}</p>
            </div>
          ))}
        </section>
      )}

      {toolCount < 5 && (
        <p class="notice">Diese Kategorie wird gerade gefüllt.</p>
      )}

      <p class="tool-count">{toolCount} {toolCount === 1 ? "Tool" : "Tools"} in dieser Kategorie</p>

      <div class="tools-grid">
        {tools.map((tool) => (
          <a href={`/tools/${tool.slug}/`} class="card tool-card">
            <div class="tool-header">
              <div class="tool-image">
                {tool.iconUrl ? (
                  <span class="tool-card-logo">
                    <img src={tool.iconUrl} alt={tool.title} loading="lazy" />
                  </span>
                ) : tool.fallbackIcon === "ai" ? (
                  <span class="tool-card-logo" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                      <path
                        d="M9 3a1 1 0 0 1 1 1v1.1a6.002 6.002 0 0 1 4 0V4a1 1 0 1 1 2 0v2.1a6.002 6.002 0 0 1 3 5.2V13a1 1 0 0 1-1 1h-1.1a6.002 6.002 0 0 1-5.2 3V19a1 1 0 1 1-2 0v-2.1a6.002 6.002 0 0 1-5.2-3H4a1 1 0 0 1-1-1v-1.7a6.002 6.002 0 0 1 3-5.2V4a1 1 0 0 1 2 0v1.1a6.01 6.01 0 0 1 1-.1Zm3 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                ) : tool.fallbackIcon === "automation" ? (
                  <span class="tool-card-logo" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                      <path
                        d="M7 4a3 3 0 0 1 3 3v1h4V7a3 3 0 1 1 6 0v3a3 3 0 0 1-3 3h-1v2h1a3 3 0 1 1-3 3v-1h-4v1a3 3 0 1 1-6 0v-3a3 3 0 0 1 3-3h1v-2H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3Zm0 2a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h3v4H7a1 1 0 0 0-1 1v3a1 1 0 1 0 2 0v-1h8v1a1 1 0 1 0 2 0v-3a1 1 0 0 0-1-1h-3v-4h3a1 1 0 0 0 1-1V7a1 1 0 1 0-2 0v1H8V7a1 1 0 0 0-1-1Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                ) : tool.fallbackIcon === "design" ? (
                  <span class="tool-card-logo" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                      <path
                        d="M6 3a3 3 0 0 0-3 3v9a6 6 0 0 0 12 0V6a3 3 0 0 0-3-3H6Zm0 2h6a1 1 0 0 1 1 1v9a4 4 0 1 1-8 0V6a1 1 0 0 1 1-1Zm12 2a3 3 0 0 1 3 3v5a6 6 0 0 1-6 6h-1.5a7.97 7.97 0 0 0 2.5-6V7h2Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                ) : (
                  <span class="tool-card-logo" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                      <path
                        d="M5 5h14a2 2 0 0 1 2 2v3H3V7a2 2 0 0 1 2-2Zm-2 7h18v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm4 2v3h2v-3H7Zm4 0v3h6v-3h-6Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                )}
              </div>
              <div class="tool-info">
                <h3 class="tool-title">{tool.title}</h3>
                <p class="tools-desc">{tool.excerpt || "Kurzbeschreibung folgt."}</p>
              </div>
            </div>
            <div class="tool-badges">
              {tool.category && (
                <span class="badge badge-category">{tool.category}</span>
              )}
              {tool.priceModel && (
                <span class="badge badge-price">{tool.priceModel}</span>
              )}
            </div>
          </a>
        ))}
      </div>
    </section>
  </div>
</BaseLayout>

<style>
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .category-page {
    padding: 40px 0 60px;
  }

  .breadcrumb {
    margin-bottom: 24px;
  }

  .breadcrumb a {
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.9375rem;
  }

  .breadcrumb a:hover {
    color: var(--accent);
  }

  .page-title {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 600;
    letter-spacing: -0.02em;
    margin-bottom: 16px;
    color: var(--text);
  }

  .page-description {
    font-size: 1.0625rem;
    line-height: 1.65;
    color: var(--text-muted);
    margin-bottom: 12px;
    max-width: 720px;
  }

  .notice {
    padding: 12px 16px;
    background: var(--surface);
    border-left: 3px solid var(--accent);
    border-radius: var(--radius);
    font-size: 0.9375rem;
    color: var(--text-muted);
    margin-bottom: 12px;
  }

  .tool-count {
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 32px;
  }

  .tools-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  @media (min-width: 700px) {
    .tools-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (min-width: 1024px) {
    .tools-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  /* SEO Content Block */
  .category-seo {
    max-width: 720px;
    margin: 32px 0;
    padding: 24px 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }

  .seo-intro {
    font-size: 1rem;
    line-height: 1.7;
    color: var(--text);
    margin-bottom: 24px;
  }

  .seo-intro :global(p) {
    margin-bottom: 16px;
  }

  .seo-intro :global(p:last-child) {
    margin-bottom: 0;
  }

  .seo-section {
    margin-bottom: 24px;
  }

  .seo-section:last-child {
    margin-bottom: 0;
  }

  .seo-section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 12px;
    margin-top: 0;
  }

  .seo-section-text {
    font-size: 1rem;
    line-height: 1.7;
    color: var(--text);
    margin: 0;
  }
</style>
