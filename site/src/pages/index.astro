---
import BaseLayout from "../layouts/BaseLayout.astro";
import { readdir, readFile } from "node:fs/promises";
import { join, parse } from "node:path";
import matter from "gray-matter";

// Load tools and build tag frequency map
const toolsDir = join(process.cwd(), "content", "tools");
const toolImagesDir = join(process.cwd(), "public", "images", "tools");
const files = (await readdir(toolsDir))
  .filter((f) => f.endsWith(".md") && !f.startsWith("_"));
let toolImageFiles: string[] = [];
try {
  toolImageFiles = await readdir(toolImagesDir);
} catch {
  toolImageFiles = [];
}
const imageExtensions = new Set([".png", ".jpg", ".jpeg", ".webp", ".svg"]);
const toolImageBySlug = new Map(
  toolImageFiles.filter((file) => {
    const extension = parse(file).ext.toLowerCase();
    return imageExtensions.has(extension);
  }).map((file) => {
    const { name } = parse(file);
    return [name, `/images/tools/${file}`];
  })
);

const buildExcerpt = (description: string | null, content: string) => {
  const source = description ?? content;
  const cleaned = source
    .replace(/```[\s\S]*?```/g, " ")
    .replace(/<[^>]*>/g, " ")
    .replace(/\[([^\]]+)\]\([^)]+\)/g, "$1")
    .replace(/[#>*_`~]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
  if (!cleaned) return null;
  return cleaned.length > 140 ? `${cleaned.slice(0, 137)}…` : cleaned;
};

const tools = await Promise.all(
  files.map(async (file) => {
    const full = join(toolsDir, file);
    const raw = await readFile(full, "utf-8");
    const { data, content } = matter(raw);
    const slug = String(data.slug ?? file.replace(/\.md$/, ""));
    const title = String(data.title ?? slug);
    const category = data.category ? String(data.category) : null;
    const price_model = data.price_model ? String(data.price_model) : null;
    const description = data.description ? String(data.description) : null;
    const fallbackImage = toolImageBySlug.get(slug) ?? null;
    const image = data.image ? String(data.image) : fallbackImage;
    const excerpt = buildExcerpt(description, content);
    const tags = Array.isArray(data.tags) ? data.tags.map(String) : [];
    return { slug, title, category, price_model, image, excerpt, tags };
  })
);

tools.sort((a, b) => a.title.localeCompare(b.title, "de"));

// Build tag frequency map
const tagFrequency = new Map<string, number>();
tools.forEach((tool) => {
  tool.tags.forEach((tag) => {
    tagFrequency.set(tag, (tagFrequency.get(tag) || 0) + 1);
  });
});

// Sort tags by frequency and name
const sortedTags = Array.from(tagFrequency.entries())
  .sort((a, b) => {
    if (b[1] !== a[1]) return b[1] - a[1]; // Sort by frequency descending
    return a[0].localeCompare(b[0], "de"); // Then by name
  });

// Assign frequency classes (high/medium/low)
const getFrequencyClass = (count: number, max: number) => {
  const ratio = count / max;
  if (ratio >= 0.6) return "tag-freq-high";
  if (ratio >= 0.3) return "tag-freq-medium";
  return "tag-freq-low";
};

const maxFrequency = sortedTags.length > 0 ? sortedTags[0][1] : 1;

const latestTools = tools.slice(0, 6);
---

<BaseLayout
  title="Utildesk — Tools & Guides für AI und Produktivität"
  description="Kuratiertes Verzeichnis nützlicher AI- und Produktivitätstools."
>
  <!-- Hero Section -->
  <section class="hero">
    <h1 class="hero-title">Utildesk</h1>
    <p class="hero-subtitle">
      Tools & Guides für AI, Automatisierung und Produktivität.
      Kuratiertes Verzeichnis mit allem, was du für effizientes Arbeiten brauchst.
    </p>
    <a href="/tools/" class="hero-cta">
      Alle Tools durchsuchen →
    </a>
  </section>

  <!-- Tag Cloud Section -->
  <section class="section">
    <div class="section-header">
      <h2 class="section-title">Nach Themen durchsuchen</h2>
      <p class="section-subtitle">
        Finde Tools nach Tags und Kategorien
      </p>
    </div>

    {sortedTags.length > 0 ? (
      <div class="tag-cloud">
        {sortedTags.map(([tag, count]) => (
          <a
            href={`/tools/?tag=${encodeURIComponent(tag)}`}
            class={`tag-cloud-item ${getFrequencyClass(count, maxFrequency)}`}
          >
            {tag}
          </a>
        ))}
      </div>
    ) : (
      <p style="text-align: center; color: var(--text-muted);">
        Keine Tags gefunden.
      </p>
    )}
  </section>

  <!-- Latest Tools Section -->
  <section class="section">
    <div class="section-header">
      <h2 class="section-title">Neueste Tools</h2>
      <p class="section-subtitle">
        Eine Auswahl aus unserem Verzeichnis
      </p>
    </div>

    <div class="tools-grid">
      {latestTools.map((tool) => (
        <a href={`/tools/${tool.slug}/`} class="card tool-card">
          <div class="tool-header">
            <div class="tool-image">
              {tool.image ? (
                <img src={tool.image} alt={tool.title} />
              ) : null}
            </div>
            <div class="tool-info">
              <h3 class="tool-title">{tool.title}</h3>
              <p class="tool-meta">{tool.slug}</p>
              {tool.excerpt && <p class="tool-excerpt">{tool.excerpt}</p>}
            </div>
          </div>
          <div class="tool-badges">
            {tool.category && (
              <span class="badge badge-category">{tool.category}</span>
            )}
            {tool.price_model && (
              <span class="badge badge-price">{tool.price_model}</span>
            )}
          </div>
        </a>
      ))}
    </div>

    <div style="text-align: center; margin-top: 48px;">
      <a href="/tools/" class="hero-cta">
        Alle {tools.length} Tools durchsuchen →
      </a>
    </div>
  </section>
</BaseLayout>
