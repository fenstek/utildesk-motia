---
import BaseLayout from "../layouts/BaseLayout.astro";
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { resolveLocalLogo } from "../lib/resolveLogoPath";

// Load tools and build tag frequency map
const toolsDir = join(process.cwd(), "content", "tools");
const files = (await readdir(toolsDir))
  .filter((f) => f.endsWith(".md") && !f.startsWith("_"));

const stripMarkdown = (text: string) =>
  text
    .replace(/!\[[^\]]*]\([^)]*\)/g, "")
    .replace(/\[[^\]]*]\([^)]*\)/g, "$1")
    .replace(/[`*_>#-]/g, "")
    .replace(/\s+/g, " ")
    .trim();


const faviconFromUrl = (url: string | null, size = 128) => {
  if (!url) return null;
  try {
    const u = new URL(url);
    return `https://www.google.com/s2/favicons?sz=${size}&domain=${encodeURIComponent(u.hostname)}`;
  } catch {
    return null;
  }
};


const getExcerpt = (content: string) => {
  const paragraphs = content.split(/\n\s*\n/);
  for (const paragraph of paragraphs) {
    if (paragraph.trim().startsWith("#")) continue;
    const cleaned = stripMarkdown(paragraph);
    if (cleaned) return cleaned;
  }
  return "";
};

const getImageFromContent = (content: string) => {
  const match = content.match(/!\[[^\]]*]\(([^)]+)\)/);
  if (!match?.[1]) return null;
  return match[1].trim();
};

const normalizeImagePath = (path: string | null) => {
  if (!path) return null;
  if (path.startsWith("http://") || path.startsWith("https://")) return path;
  if (path.startsWith("/")) return path;
  return `/${path}`;
};

const resolveCategoryIcon = (category: string | null, tags: string[]) => {
  const normalizedCategory = category ? category.toLowerCase() : "";
  const normalizedTags = tags.map((tag) => tag.toLowerCase());
  const combined = [normalizedCategory, ...normalizedTags].join(" ");

  if (combined.includes("design") || combined.includes("ui") || combined.includes("ux")) {
    return "design";
  }
  if (combined.includes("automation") || combined.includes("workflow")) {
    return "automation";
  }
  if (combined.includes("ai") || combined.includes("ml") || combined.includes("machine")) {
    return "ai";
  }
  return "generic";
};

const tools = await Promise.all(
  files.map(async (file) => {
    const full = join(toolsDir, file);
    const raw = await readFile(full, "utf-8");
    const { data, content } = matter(raw);
    const disabled = data.disabled === true || String(data.disabled || "").toLowerCase() === "true";
    if (disabled) return null;
    const slug = String(data.slug ?? file.replace(/\.md$/, ""));
    const title = String(data.title ?? slug);
    const category = data.category ? String(data.category) : null;
    const price_model = data.price_model ? String(data.price_model) : null;
    const affiliate_url = data.affiliate_url ? String(data.affiliate_url) : null;
    const official_url = data.official_url ? String(data.official_url) : null;
    const image = data.image ? String(data.image) : null;
    const homeImage = data.homeImage ? String(data.homeImage) : null;
    const brandLogo = data.brandLogo ? String(data.brandLogo) : null;
    const icon = data.icon ? String(data.icon) : null;
    const tags = Array.isArray(data.tags) ? data.tags.map(String) : [];
    const description = data.description
      ? String(data.description)
      : data.summary
        ? String(data.summary)
        : data.excerpt
          ? String(data.excerpt)
          : "";
    const excerpt = description || getExcerpt(content);
    const contentImage = getImageFromContent(content);
    const localLogoPath = resolveLocalLogo(slug);
    const providerUrl = affiliate_url || official_url;
    const faviconLogo = faviconFromUrl(providerUrl);
    const homeCardLogo = normalizeImagePath(brandLogo) ?? localLogoPath ?? faviconLogo;
    const homeCardImage = normalizeImagePath(homeImage ?? image ?? icon ?? contentImage);
    return {
      slug,
      title,
      category,
      price_model,
      image,
      homeImage,
      brandLogo,
      tags,
      excerpt,
      homeCardImage,
      homeCardLogo,
      fallbackIcon: resolveCategoryIcon(category, tags),
    };
  })
);

const enabledTools = tools.filter(Boolean);
enabledTools.sort((a, b) => a.title.localeCompare(b.title, "de"));

// Build tag frequency map
const tagFrequency = new Map<string, number>();
enabledTools.forEach((tool) => {
  tool.tags.forEach((tag) => {
    tagFrequency.set(tag, (tagFrequency.get(tag) || 0) + 1);
  });
});

// Sort tags by frequency and name
const sortedTags = Array.from(tagFrequency.entries())
  .sort((a, b) => {
    if (b[1] !== a[1]) return b[1] - a[1]; // Sort by frequency descending
    return a[0].localeCompare(b[0], "de"); // Then by name
  });

// Assign frequency classes (high/medium/low)
const getFrequencyClass = (count: number, max: number) => {
  const ratio = count / max;
  if (ratio >= 0.6) return "tag-freq-high";
  if (ratio >= 0.3) return "tag-freq-medium";
  return "tag-freq-low";
};

const maxFrequency = sortedTags.length > 0 ? sortedTags[0][1] : 1;

// Pinned tools in fixed order
const pinnedSlugs = ["chatgpt", "claude", "midjourney", "perplexity", "zapier"];
const enabledBySlug = new Map(enabledTools.map((t) => [t.slug, t]));

// Get pinned tools in specified order (only existing ones)
const pinnedTools = pinnedSlugs
  .map((slug) => enabledBySlug.get(slug))
  .filter(Boolean);

// Get remaining tools (not pinned)
const pinnedSlugSet = new Set(pinnedSlugs);
const restTools = enabledTools.filter((t) => !pinnedSlugSet.has(t.slug));

// Sort rest by popularity desc, then by title
restTools.sort(
  (a, b) =>
    (b.popularity ?? 0) - (a.popularity ?? 0) ||
    a.title.localeCompare(b.title, "de")
);

// Combine: pinned first, then top by popularity, limit to 12
const latestTools = [...pinnedTools, ...restTools].slice(0, 12);
---

<BaseLayout
  title="Utildesk — Tools & Guides für AI und Produktivität"
  description="Kuratiertes Verzeichnis nützlicher AI- und Produktivitätstools."
>
  <Fragment slot="head">
    <link rel="canonical" href="https://tools.utildesk.de/" />
  </Fragment>

  <!-- Hero Section -->
  <style>
    .home-v2.home-hero > h1,
    .home-v2.home-hero > p {
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Tag cloud redesign */
    .home-v2 .tag-cloud {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px 10px;
      margin: 10px auto 4px;
      max-width: 620px;
    }

    .home-v2 .tag-cloud a {
      display: inline-flex;
      align-items: center;
      padding: 8px 12px;
      border-radius: 999px;
      text-decoration: none;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.35);
      backdrop-filter: blur(6px);
      font-size: 0.95rem;
      line-height: 1;
      transition: top .12s ease, background .12s ease;
      position: relative;
      top: var(--y, 0px);
    }

    .home-v2 .tag-cloud a:hover {
      top: calc(var(--y, 0px) - 2px);
      background: rgba(255,255,255,.55);
    }

    /* Cloud staggering */
    .home-v2 .tag-cloud a:nth-child(3n+1) { --y: 10px; }
    .home-v2 .tag-cloud a:nth-child(3n+2) { --y: -10px; }
    .home-v2 .tag-cloud a:nth-child(3n) { --y: 0px; }

    /* Size variety */
    .home-v2 .tag-cloud a:nth-child(4n+1) {
      font-size: 1.02rem;
      padding: 9px 14px;
    }
    .home-v2 .tag-cloud a:nth-child(4n+3) {
      font-size: 0.92rem;
      padding: 7px 11px;
    }

    .home-v2.home-tags {
      padding-top: 12px;
      padding-bottom: 10px;
    }
  </style>
  <section class="hero home-hero home-v2">
    <h1 class="hero-title">Utildesk</h1>
    <p class="hero-subtitle">
      Tools & Guides für AI, Automatisierung und Produktivität.
      Kuratiertes Verzeichnis mit allem, was du für effizientes Arbeiten brauchst.
    </p>
    <a href="/tools/" class="hero-cta">
      Alle Tools durchsuchen →
    </a>
  </section>

  <!-- Tag Cloud Section -->
  <section class="section home-section home-tags home-v2">
    {sortedTags.length > 0 ? (
      <div class="tag-cloud home-tags-cloud">
        {sortedTags.map(([tag, count]) => (
          <a
            href={`/tools/?tag=${encodeURIComponent(tag)}`}
            class={`tag-cloud-item ${getFrequencyClass(count, maxFrequency)}`}
          >
            {tag}
          </a>
        ))}
      </div>
    ) : (
      <p style="text-align: center; color: var(--text-muted);">
        Keine Tags gefunden.
      </p>
    )}
  </section>

  <!-- Featured Tools Section -->
  <section class="section home-section">
    <div class="section-header home-section-header">
      <h2 class="section-title">Featured Tools</h2>
      <p class="section-subtitle">
        Eine Auswahl aus unserem Verzeichnis
      </p>
    </div>

    <div class="home-card-grid">
      {latestTools.map((tool) => (
        <a href={`/tools/${tool.slug}/`} class="home-card">
          <div class="home-card-media">
            <div class="home-card-img">
              {tool.homeCardLogo ? (
                <span class="home-card-logo">
                  <img src={tool.homeCardLogo} alt={tool.title} loading="lazy" />
                </span>
              ) : tool.homeCardImage ? (
                <img src={tool.homeCardImage} alt={tool.title} loading="lazy" />
              ) : tool.fallbackIcon === "ai" ? (
                <span class="home-card-logo" aria-hidden="true">
                  <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                    <path
                      d="M9 3a1 1 0 0 1 1 1v1.1a6.002 6.002 0 0 1 4 0V4a1 1 0 1 1 2 0v2.1a6.002 6.002 0 0 1 3 5.2V13a1 1 0 0 1-1 1h-1.1a6.002 6.002 0 0 1-5.2 3V19a1 1 0 1 1-2 0v-2.1a6.002 6.002 0 0 1-5.2-3H4a1 1 0 0 1-1-1v-1.7a6.002 6.002 0 0 1 3-5.2V4a1 1 0 0 1 2 0v1.1a6.01 6.01 0 0 1 1-.1Zm3 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"
                      fill="currentColor"
                    />
                  </svg>
                </span>
              ) : tool.fallbackIcon === "automation" ? (
                <span class="home-card-logo" aria-hidden="true">
                  <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                    <path
                      d="M7 4a3 3 0 0 1 3 3v1h4V7a3 3 0 1 1 6 0v3a3 3 0 0 1-3 3h-1v2h1a3 3 0 1 1-3 3v-1h-4v1a3 3 0 1 1-6 0v-3a3 3 0 0 1 3-3h1v-2H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3Zm0 2a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h3v4H7a1 1 0 0 0-1 1v3a1 1 0 1 0 2 0v-1h8v1a1 1 0 1 0 2 0v-3a1 1 0 0 0-1-1h-3v-4h3a1 1 0 0 0 1-1V7a1 1 0 1 0-2 0v1H8V7a1 1 0 0 0-1-1Z"
                      fill="currentColor"
                    />
                  </svg>
                </span>
              ) : tool.fallbackIcon === "design" ? (
                <span class="home-card-logo" aria-hidden="true">
                  <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                    <path
                      d="M6 3a3 3 0 0 0-3 3v9a6 6 0 0 0 12 0V6a3 3 0 0 0-3-3H6Zm0 2h6a1 1 0 0 1 1 1v9a4 4 0 1 1-8 0V6a1 1 0 0 1 1-1Zm12 2a3 3 0 0 1 3 3v5a6 6 0 0 1-6 6h-1.5a7.97 7.97 0 0 0 2.5-6V7h2Z"
                      fill="currentColor"
                    />
                  </svg>
                </span>
              ) : (
                <span class="home-card-logo" aria-hidden="true">
                  <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                    <path
                      d="M5 5h14a2 2 0 0 1 2 2v3H3V7a2 2 0 0 1 2-2Zm-2 7h18v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm4 2v3h2v-3H7Zm4 0v3h6v-3h-6Z"
                      fill="currentColor"
                    />
                  </svg>
                </span>
              )}
            </div>
            <div class="home-card-body">
              <h3 class="home-card-title">{tool.title}</h3>
            </div>
          </div>
        </a>
      ))}
    </div>

    <div style="text-align: center; margin-top: 48px;">
      <a href="/tools/" class="hero-cta">
        Alle {enabledTools.length} Tools durchsuchen →
      </a>
    </div>
  </section>
</BaseLayout>
