---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { readdir, readFile, stat } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { resolveLocalLogo } from "../../lib/resolveLogoPath";

const toolsDir = join(process.cwd(), "content", "tools");
const files = (await readdir(toolsDir))
  .filter((f) => f.endsWith(".md") && !f.startsWith("_"));

const stripMarkdown = (text: string) =>
  text
    .replace(/!\[[^\]]*]\([^)]*\)/g, "")
    .replace(/\[[^\]]*]\([^)]*\)/g, "$1")
    .replace(/[`*_>#-]/g, "")
    .replace(/\s+/g, " ")
    .trim();

const faviconFromUrl = (url: string | null, size = 128) => {
  if (!url) return null;
  try {
    const u = new URL(url);
    return `https://www.google.com/s2/favicons?sz=${size}&domain=${encodeURIComponent(u.hostname)}`;
  } catch {
    return null;
  }
};

const getExcerpt = (content: string) => {
  const paragraphs = content.split(/\n\s*\n/);
  for (const paragraph of paragraphs) {
    if (paragraph.trim().startsWith("#")) continue;
    const cleaned = stripMarkdown(paragraph);
    if (cleaned) return cleaned;
  }
  return "";
};



const resolveCategoryIcon = (category: string | null, tags: string[]) => {
  const normalizedCategory = category ? category.toLowerCase() : "";
  const normalizedTags = tags.map((tag) => tag.toLowerCase());
  const combined = [normalizedCategory, ...normalizedTags].join(" ");

  if (combined.includes("design") || combined.includes("ui") || combined.includes("ux")) {
    return "design";
  }
  if (combined.includes("automation") || combined.includes("workflow")) {
    return "automation";
  }
  if (combined.includes("ai") || combined.includes("ml") || combined.includes("machine")) {
    return "ai";
  }
  return "generic";
};



const tools = await Promise.all(
  files.map(async (file) => {
    const full = join(toolsDir, file);
    const stats = await stat(full);
    const raw = await readFile(full, "utf-8");
    const { data, content } = matter(raw);
    const disabled = data.disabled === true || String(data.disabled || "").toLowerCase() === "true";
    if (disabled) return null;
    const slug = String(data.slug ?? file.replace(/\.md$/, ""));
    const title = String(data.title ?? slug);
    const category = data.category ? String(data.category) : null;
    const price_model = data.price_model ? String(data.price_model) : null;
    const affiliate_url = data.affiliate_url ? String(data.affiliate_url) : null;
    const official_url = data.official_url ? String(data.official_url) : null;
    const brandLogo = data.brandLogo ? String(data.brandLogo) : null;
    const providerUrl = affiliate_url || official_url;
    const localLogo = resolveLocalLogo(slug);
    const faviconLogo = faviconFromUrl(providerUrl);
    const iconUrl = brandLogo || localLogo || faviconLogo;
    const tags = Array.isArray(data.tags) ? data.tags.map(String) : [];
    const description = data.description
      ? String(data.description)
      : data.summary
        ? String(data.summary)
        : data.excerpt
          ? String(data.excerpt)
          : data.tagline
            ? String(data.tagline)
            : "";
    const excerpt = description || getExcerpt(content);
    return {
      slug,
      title,
      category,
      price_model,
      iconUrl,
      tags,
      excerpt,
      addedAtMs: Number(stats.mtimeMs || 0),
      popularity: 0,
      fallbackIcon: resolveCategoryIcon(category, tags),
    };
  })
);

const enabledTools = tools.filter(Boolean);
enabledTools.sort((a, b) => a.title.localeCompare(b.title, "de"));

// Build unique tag list
const allTags = new Set<string>();
enabledTools.forEach((tool) => {
  tool.tags.forEach((tag) => allTags.add(tag));
});
const sortedTags = Array.from(allTags).sort((a, b) => a.localeCompare(b, "de"));
---

<BaseLayout
  title="Tools — Utildesk"
  description="Kuratiertes Verzeichnis nützlicher AI- und Produktivitätstools"
>
  <Fragment slot="head">
    <link rel="canonical" href="https://tools.utildesk.de/tools/" />
  </Fragment>

  <!-- Hero -->
  <section class="hero" style="padding: 60px 0 40px;">
    <h1 class="hero-title">Tools</h1>
    <p class="hero-subtitle">
      Kuratiertes Verzeichnis nützlicher AI- und Produktivitätstools.
      Durchsuche alle Tools oder filtere nach Tags.
    </p>
  </section>

  <!-- Tag Filter Row -->
  {sortedTags.length > 0 && (
    <div class="tag-filter-row" id="tag-filter-row">
      <label class="tag-filter-label">Nach Tags filtern:</label>
      <div class="tag-filter-list" id="tag-filter-list">
        {sortedTags.map((tag) => (
          <a
            href={`/tools/?tag=${encodeURIComponent(tag)}`}
            class="tag-filter-item"
            data-tag={tag}
          >
            {tag}
          </a>
        ))}
        <a href="/tools/" class="clear-filter-btn" id="clear-filter-btn" style="display: none;">
          Filter löschen
        </a>
      </div>
    </div>
  )}

  <!-- Search -->
  <div class="search-wrapper">
    <input
      type="search"
      id="search-input"
      class="search-input"
      placeholder="Tools suchen…"
      autocomplete="off"
    />
    <select id="sort-select" class="search-input" aria-label="Sortierung">
      <option value="alpha">Alphabetisch (A–Z)</option>
      <option value="newest">Neueste zuerst</option>
      <option value="oldest">Älteste zuerst</option>
      <option value="popular">Beliebteste zuerst</option>
    </select>
  </div>

  <!-- Tools Grid -->
  <div class="tools-grid" id="tools-grid">
    {enabledTools.map((tool) => (
      <a
        href={`/tools/${tool.slug}/`}
        class="card tool-card"
        data-title={tool.title.toLowerCase()}
        data-slug={tool.slug.toLowerCase()}
        data-tags={tool.tags.map((tag) => tag.toLowerCase()).join(",")}
        data-added={tool.addedAtMs}
        data-popularity={tool.popularity}
      >
        <div class="tool-header">
          <div class="tool-image">
            {tool.iconUrl ? (
              <span class="tool-card-logo">
                <img src={tool.iconUrl} alt={tool.title} loading="lazy" />
              </span>
            ) : tool.fallbackIcon === "ai" ? (
              <span class="tool-card-logo" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                  <path
                    d="M9 3a1 1 0 0 1 1 1v1.1a6.002 6.002 0 0 1 4 0V4a1 1 0 1 1 2 0v2.1a6.002 6.002 0 0 1 3 5.2V13a1 1 0 0 1-1 1h-1.1a6.002 6.002 0 0 1-5.2 3V19a1 1 0 1 1-2 0v-2.1a6.002 6.002 0 0 1-5.2-3H4a1 1 0 0 1-1-1v-1.7a6.002 6.002 0 0 1 3-5.2V4a1 1 0 0 1 2 0v1.1a6.01 6.01 0 0 1 1-.1Zm3 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"
                    fill="currentColor"
                  />
                </svg>
              </span>
            ) : tool.fallbackIcon === "automation" ? (
              <span class="tool-card-logo" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                  <path
                    d="M7 4a3 3 0 0 1 3 3v1h4V7a3 3 0 1 1 6 0v3a3 3 0 0 1-3 3h-1v2h1a3 3 0 1 1-3 3v-1h-4v1a3 3 0 1 1-6 0v-3a3 3 0 0 1 3-3h1v-2H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3Zm0 2a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h3v4H7a1 1 0 0 0-1 1v3a1 1 0 1 0 2 0v-1h8v1a1 1 0 1 0 2 0v-3a1 1 0 0 0-1-1h-3v-4h3a1 1 0 0 0 1-1V7a1 1 0 1 0-2 0v1H8V7a1 1 0 0 0-1-1Z"
                    fill="currentColor"
                  />
                </svg>
              </span>
            ) : tool.fallbackIcon === "design" ? (
              <span class="tool-card-logo" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                  <path
                    d="M6 3a3 3 0 0 0-3 3v9a6 6 0 0 0 12 0V6a3 3 0 0 0-3-3H6Zm0 2h6a1 1 0 0 1 1 1v9a4 4 0 1 1-8 0V6a1 1 0 0 1 1-1Zm12 2a3 3 0 0 1 3 3v5a6 6 0 0 1-6 6h-1.5a7.97 7.97 0 0 0 2.5-6V7h2Z"
                    fill="currentColor"
                  />
                </svg>
              </span>
            ) : (
              <span class="tool-card-logo" aria-hidden="true">
                <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                  <path
                    d="M5 5h14a2 2 0 0 1 2 2v3H3V7a2 2 0 0 1 2-2Zm-2 7h18v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm4 2v3h2v-3H7Zm4 0v3h6v-3h-6Z"
                    fill="currentColor"
                  />
                </svg>
              </span>
            )}
          </div>
          <div class="tool-info">
            <h3 class="tool-title">{tool.title}</h3>
            <p class="tools-desc">{tool.excerpt || "Kurzbeschreibung folgt."}</p>
          </div>
        </div>
        <div class="tool-badges">
          {tool.category && (
            <span class="badge badge-category">{tool.category}</span>
          )}
          {tool.price_model && (
            <span class="badge badge-price">{tool.price_model}</span>
          )}
        </div>
      </a>
    ))}
  </div>

  <!-- No results message (hidden by default) -->
  <div id="no-results" style="display: none; text-align: center; padding: 60px 0;">
    <p style="color: var(--text-muted); font-size: 1.125rem;">
      Keine Tools gefunden. Versuche einen anderen Suchbegriff oder filtere nach einem anderen Tag.
    </p>
  </div>
  <div style="text-align: center; margin-top: 36px; padding-bottom: 48px;">
    <button type="button" id="load-more-btn" class="hero-cta">Mehr anzeigen</button>
    <div
      id="hidden-count-info"
      style="display: none; margin-top: 10px; text-align: center; font-size: 0.9rem; color: rgba(0,0,0,0.6);"
    >
      Noch 0 Tools verborgen
    </div>
  </div>

  <!-- Client-side search + tag filter script (inline, no build tools) -->
  <script is:inline>
    (function() {
      const searchInput = document.getElementById('search-input');
      const sortSelect = document.getElementById('sort-select');
      const toolsGrid = document.getElementById('tools-grid');
      const noResults = document.getElementById('no-results');
      const loadMoreBtn = document.getElementById('load-more-btn');
      const hiddenCountInfo = document.getElementById('hidden-count-info');
      const cards = Array.from(toolsGrid.querySelectorAll('.tool-card'));
      const tagFilterItems = document.querySelectorAll('.tag-filter-item');
      const clearFilterBtn = document.getElementById('clear-filter-btn');

      let activeTag = null;
      let pageBlocks = 1;

      // Read URL param ?tag=
      const urlParams = new URLSearchParams(window.location.search);
      const initialTag = urlParams.get('tag');

      if (initialTag) {
        activeTag = initialTag.toLowerCase();
        // Highlight active tag
        tagFilterItems.forEach(function(item) {
          if (item.getAttribute('data-tag').toLowerCase() === activeTag) {
            item.classList.add('active');
          }
        });
        if (clearFilterBtn) {
          clearFilterBtn.style.display = 'inline-flex';
        }
      }

      function getCols() {
        const template = window.getComputedStyle(toolsGrid).gridTemplateColumns || '';
        if (!template || template === 'none') return 1;
        const cols = template.split(' ').filter(function(part) { return part.trim().length > 0; }).length;
        return cols > 0 ? cols : 1;
      }

      function getStep() {
        return getCols() * 6;
      }

      // Filter + sort + pagination
      function filterTools() {
        const query = searchInput.value.toLowerCase().trim();
        const sortMode = sortSelect ? sortSelect.value : 'alpha';
        const filtered = cards.filter(function(card) {
          const title = card.getAttribute('data-title') || '';
          const slug = card.getAttribute('data-slug') || '';
          const tags = card.getAttribute('data-tags') || '';
          const tagList = tags.split(',').map(function(t) { return t.trim().toLowerCase(); });

          // Check search query match
          const searchMatch = !query ||
                             title.includes(query) ||
                             slug.includes(query) ||
                             tags.includes(query);

          // Check tag filter match
          const tagMatch = !activeTag || tagList.includes(activeTag);

          return searchMatch && tagMatch;
        });

        filtered.sort(function(a, b) {
          const aTitle = (a.getAttribute('data-title') || '').toLowerCase();
          const bTitle = (b.getAttribute('data-title') || '').toLowerCase();
          if (sortMode === 'newest') {
            const aAdded = Number(a.getAttribute('data-added') || '0');
            const bAdded = Number(b.getAttribute('data-added') || '0');
            if (bAdded !== aAdded) return bAdded - aAdded;
            return aTitle.localeCompare(bTitle, 'de');
          }
          if (sortMode === 'oldest') {
            const aAdded = Number(a.getAttribute('data-added') || '0');
            const bAdded = Number(b.getAttribute('data-added') || '0');
            if (aAdded !== bAdded) return aAdded - bAdded;
            return aTitle.localeCompare(bTitle, 'de');
          }
          if (sortMode === 'popular') {
            const aPopular = Number(a.getAttribute('data-popularity') || '0');
            const bPopular = Number(b.getAttribute('data-popularity') || '0');
            if (bPopular !== aPopular) return bPopular - aPopular;
            return aTitle.localeCompare(bTitle, 'de');
          }
          return aTitle.localeCompare(bTitle, 'de');
        });

        const limit = getStep() * pageBlocks;
        const visibleCards = filtered.slice(0, limit);

        toolsGrid.innerHTML = '';
        visibleCards.forEach(function(card) {
          toolsGrid.appendChild(card);
        });

        const totalFiltered = filtered.length;
        const currentVisible = visibleCards.length;
        const hidden = totalFiltered - currentVisible;

        // Show/hide no results message
        if (totalFiltered === 0) {
          toolsGrid.style.display = 'none';
          noResults.style.display = 'block';
        } else {
          toolsGrid.style.display = 'grid';
          noResults.style.display = 'none';
        }

        if (loadMoreBtn) {
          if (totalFiltered > limit) {
            loadMoreBtn.style.display = 'inline-flex';
          } else {
            loadMoreBtn.style.display = 'none';
          }
        }

        if (hiddenCountInfo) {
          if (hidden > 0) {
            hiddenCountInfo.textContent = 'Noch ' + hidden + ' Tools verborgen';
            hiddenCountInfo.style.display = 'block';
          } else {
            hiddenCountInfo.style.display = 'none';
          }
        }
      }

      function resetAndFilter() {
        pageBlocks = 1;
        filterTools();
      }

      // Search input listener
      searchInput.addEventListener('input', resetAndFilter);

      if (sortSelect) {
        sortSelect.addEventListener('change', resetAndFilter);
      }

      // Tag filter click listener
      tagFilterItems.forEach(function(item) {
        item.addEventListener('click', function(e) {
          e.preventDefault();
          const tag = item.getAttribute('data-tag').toLowerCase();

          // Toggle active tag
          if (activeTag === tag) {
            activeTag = null;
            tagFilterItems.forEach(function(i) { i.classList.remove('active'); });
            if (clearFilterBtn) {
              clearFilterBtn.style.display = 'none';
            }
            // Update URL
            history.pushState(null, '', '/tools/');
          } else {
            activeTag = tag;
            tagFilterItems.forEach(function(i) { i.classList.remove('active'); });
            item.classList.add('active');
            if (clearFilterBtn) {
              clearFilterBtn.style.display = 'inline-flex';
            }
            // Update URL
            history.pushState(null, '', '/tools/?tag=' + encodeURIComponent(tag));
          }

          resetAndFilter();
        });
      });

      // Clear filter button listener
      if (clearFilterBtn) {
        clearFilterBtn.addEventListener('click', function(e) {
          e.preventDefault();
          activeTag = null;
          tagFilterItems.forEach(function(i) { i.classList.remove('active'); });
          clearFilterBtn.style.display = 'none';
          history.pushState(null, '', '/tools/');
          resetAndFilter();
        });
      }

      if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', function() {
          pageBlocks += 1;
          filterTools();
        });
      }

      window.addEventListener('resize', filterTools);

      // Initial filter on page load
      filterTools();
    })();
  </script>
</BaseLayout>
