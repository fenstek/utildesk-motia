---
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import BaseLayout from "../../layouts/BaseLayout.astro";

const toolsDir = join(process.cwd(), "content", "tools");
const files = (await readdir(toolsDir)).filter(
  (f) => f.endsWith(".md") && !f.startsWith("_")
);

function extractFirstMarkdownImage(md) {
  const m = md.match(/!\[[^\]]*\]\(([^)]+)\)/);
  return m ? m[1] : null;
}

function stripMarkdown(md) {
  return md
    .replace(/!\[[^\]]*\]\([^)]+\)/g, "") // images
    .replace(/\[([^\]]*)\]\([^)]+\)/g, "$1") // links -> text
    .replace(/^#{1,6}\s+.*$/gm, "") // headings
    .replace(/```[\s\S]*?```/g, "") // code blocks
    .replace(/`[^`]*`/g, "") // inline code
    .replace(/[*_~>#-]/g, " ") // some md chars
    .replace(/\s+/g, " ")
    .trim();
}

function makeExcerpt(md, max = 170) {
  const text = stripMarkdown(md);
  if (!text) return "";
  return text.length > max ? text.slice(0, max - 1).trimEnd() + "…" : text;
}

function normalizeTags(value) {
  if (!value) return [];
  if (Array.isArray(value)) return value.map(String).map((s) => s.trim()).filter(Boolean);
  if (typeof value === "string") return value.split(",").map((s) => s.trim()).filter(Boolean);
  return [];
}

const tools = await Promise.all(
  files.map(async (file) => {
    const full = join(toolsDir, file);
    const raw = await readFile(full, "utf-8");
    const { data, content } = matter(raw);

    const slug = String(data.slug ?? file.replace(/\.md$/, ""));
    const title = String(data.title ?? slug);

    const category = data.category ? String(data.category) : "";
    const price_model = data.price_model ? String(data.price_model) : "";
    const tags = normalizeTags(data.tags);

    const image =
      (data.image ? String(data.image) : "") ||
      extractFirstMarkdownImage(content) ||
      "";

    const excerpt = makeExcerpt(content, 170);

    return { slug, title, category, price_model, tags, image, excerpt };
  })
);

tools.sort((a, b) => a.title.localeCompare(b.title, "de"));
---

<BaseLayout title="Tools — utildesk" description="Kuratierte Tools mit klaren Kurzbeschreibungen.">
  <h1>Tools</h1>
  <p class="lead">Ein kuratiertes Verzeichnis — kurz, klar, ohne Marketing-Lärm.</p>

  <section class="tools-grid">
    {tools.map((t) => (
      <a class="tool-card" href={"/tools/" + t.slug + "/"}>
        {t.image ? <img class="thumb" src={t.image} alt="" loading="lazy" /> : null}
        <div class="card-body">
          <div class="card-title">{t.title}</div>
          {t.excerpt ? <p class="excerpt">{t.excerpt}</p> : null}
          <div class="pills" aria-label="Meta">
            {t.category ? <span class="pill"><strong>Category</strong> {t.category}</span> : null}
            {t.price_model ? <span class="pill"><strong>Preis</strong> {t.price_model}</span> : null}
            {(t.tags || []).slice(0, 2).map((tag) => (
              <span class="pill pill--tag">{tag}</span>
            ))}
          </div>
        </div>
      </a>
    ))}
  </section>
</BaseLayout>
