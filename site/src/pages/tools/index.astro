---
import { readdir } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";

const toolsDir = join(process.cwd(), "content", "tools");
const files = (await readdir(toolsDir))
  .filter((f) => f.endsWith(".md") && !f.startsWith("_"));

const tools = await Promise.all(
  files.map(async (file) => {
    const full = join(toolsDir, file);
    const raw = await (await import("node:fs/promises")).readFile(full, "utf-8");
    const { data, content } = matter(raw);
    const slug = String(data.slug ?? file.replace(/\.md$/, ""));
    const title = String(data.title ?? slug);

    // Extract image (from frontmatter or first markdown image)
    let image = data.image ? String(data.image) : null;
    if (!image) {
      const imgMatch = content.match(/!\[.*?\]\((.*?)\)/);
      if (imgMatch) image = imgMatch[1];
    }

    // Extract excerpt (~140 chars from content, strip headings/images/links)
    let excerpt = content
      .replace(/^#.+$/gm, '')  // Remove headings
      .replace(/!\[.*?\]\(.*?\)/g, '')  // Remove images
      .replace(/\[([^\]]+)\]\([^\)]+\)/g, '$1')  // Remove links but keep text
      .replace(/\*\*(.+?)\*\*/g, '$1')  // Remove bold
      .replace(/\n+/g, ' ')  // Replace newlines with spaces
      .trim();

    // Take first ~140 characters
    if (excerpt.length > 140) {
      excerpt = excerpt.substring(0, 140).trim() + '...';
    }

    const category = data.category ? String(data.category) : null;
    const priceModel = data.price_model ? String(data.price_model) : null;

    return { slug, title, image, excerpt, category, priceModel };
  })
);

tools.sort((a, b) => a.title.localeCompare(b.title, "de"));
---

<html lang="de">
  <head>
    <link rel="stylesheet" href="/styles/global.css" />
<meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tools</title>
</head>
  <body>
    <main>
      <div class="header">
        <div>
          <div class="badge">Utildesk · Tool Directory</div>
          <h1 class="h1">Tools</h1>
          <p class="lead">Kuratiertes Verzeichnis nützlicher AI- und Produktivitätstools.</p>
        </div>
      </div>

      <ul class="tools-list">
        {tools.map((t) => (
          <li class="card">
            <a class="tool-item" href={"/tools/" + t.slug + "/"}>
              <div class="tool-thumb" aria-hidden="true">
                {t.image && <img src={t.image} alt={t.title} />}
              </div>
              <div class="tool-content">
                <p class="tool-title">{t.title}</p>
                {t.excerpt && <p class="tool-excerpt">{t.excerpt}</p>}
                <div class="tool-badges">
                  {t.category && <span class="tool-badge">{t.category}</span>}
                  {t.priceModel && <span class="tool-badge tool-badge-price">{t.priceModel}</span>}
                </div>
              </div>
            </a>
          </li>
        ))}
      </ul>
    </main>
  </body>
</html>
