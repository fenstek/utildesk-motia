---
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";

const toolsDir = join(process.cwd(), "content", "tools");
const files = (await readdir(toolsDir)).filter(
  (f) => f.endsWith(".md") && !f.startsWith("_")
);

function extractFirstMarkdownImage(md) {
  // ![alt](url) or ![](url)
  const m = md.match(/!\[[^\]]*\]\(([^)]+)\)/);
  return m ? m[1] : null;
}

function stripMarkdown(md) {
  return md
    .replace(/!\[[^\]]*\]\([^)]+\)/g, "") // images
    .replace(/\[[^\]]*\]\([^)]+\)/g, "$1") // links -> text
    .replace(/^#{1,6}\s+.*$/gm, "") // headings
    .replace(/`{1,3}[^`]*`{1,3}/g, "") // inline code
    .replace(/```[\s\S]*?```/g, "") // code blocks
    .replace(/[*_~>#-]/g, " ") // some md chars
    .replace(/\s+/g, " ")
    .trim();
}

function makeExcerpt(md, max = 140) {
  const text = stripMarkdown(md);
  if (!text) return "";
  return text.length > max ? text.slice(0, max - 1).trimEnd() + "…" : text;
}

const tools = await Promise.all(
  files.map(async (file) => {
    const full = join(toolsDir, file);
    const raw = await readFile(full, "utf-8");
    const { data, content } = matter(raw);

    const slug = String(data.slug ?? file.replace(/\.md$/, ""));
    const title = String(data.title ?? slug);

    const category = data.category ? String(data.category) : "";
    const price_model = data.price_model ? String(data.price_model) : "";

    const image =
      (data.image ? String(data.image) : "") || extractFirstMarkdownImage(content) || "";

    const excerpt = makeExcerpt(content, 160);

    return { slug, title, category, price_model, image, excerpt };
  })
);

tools.sort((a, b) => a.title.localeCompare(b.title, "de"));
---

<html lang="de">
  <head>
    <link rel="stylesheet" href="/styles/global.css" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tools</title>
  </head>
  <body>
    <main>
      <div class="header">
        <div>
          <div class="badge">Utildesk · Tool Directory</div>
          <h1 class="h1">Tools</h1>
          <p class="lead">Kuratiertes Verzeichnis nützlicher AI- und Produktivitätstools.</p>
        </div>
      </div>

      <ul class="tools-list">
        {tools.map((t) => (
          <li class="card">
            <a class="tool-item" href={"/tools/" + t.slug + "/"}>
              <div class="tool-thumb" aria-hidden="true">
                {t.image ? <img src={t.image} alt="" loading="lazy" /> : null}
              </div>

              <div style="min-width:0;">
                <p class="tool-title">{t.title}</p>

                {(t.category || t.price_model) ? (
                  <div class="pills" aria-label="Meta">
                    {t.category ? <span class="pill">{t.category}</span> : null}
                    {t.price_model ? <span class="pill">{t.price_model}</span> : null}
                  </div>
                ) : null}

                {t.excerpt ? <p class="tool-excerpt">{t.excerpt}</p> : null}
              </div>
            </a>
          </li>
        ))}
      </ul>
    </main>
  </body>
</html>
