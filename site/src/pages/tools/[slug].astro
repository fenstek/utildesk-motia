---
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { marked } from "marked";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const toolsDir = join(process.cwd(), "content", "tools");
  const files = (await readdir(toolsDir)).filter(
    (f) => f.endsWith(".md") && !f.startsWith("_")
  );

  return files.map((file) => {
    const slug = file.replace(/\.md$/, "");
    return { params: { slug } };
  });
}

function normalizeTags(value) {
  if (!value) return [];
  if (Array.isArray(value)) return value.map(String).map((s) => s.trim()).filter(Boolean);
  if (typeof value === "string") return value.split(",").map((s) => s.trim()).filter(Boolean);
  return [];
}

/**
 * FAQ section pattern:
 * <h2>FAQ</h2>
 * <h3>Question</h3>
 * <p>Answer...</p>
 */
function faqToAccordion(html) {
  const reSection = /<h2[^>]*>\s*FAQ\s*<\/h2>([\s\S]*?)(?=<h2[^>]*>|$)/i;
  const m = html.match(reSection);
  if (!m) return { html, hasFaq: false };

  const sectionBody = m[1];
  const parts = sectionBody.split(/<h3[^>]*>/i);
  if (parts.length < 2) return { html, hasFaq: false };

  const items = [];
  for (let i = 1; i < parts.length; i++) {
    const chunk = parts[i];
    const endTitle = chunk.search(/<\/h3>/i);
    if (endTitle === -1) continue;

    const q = chunk.slice(0, endTitle).replace(/<[^>]+>/g, "").trim();
    const a = chunk.slice(endTitle).replace(/<\/h3>/i, "").trim();
    if (!q) continue;

    items.push(
      `<details>
         <summary>${q}</summary>
         <div class="answer">${a}</div>
       </details>`
    );
  }

  if (!items.length) return { html, hasFaq: false };

  const accordion = `<section class="faq"><h2>FAQ</h2>${items.join("")}</section>`;
  const replaced = html.replace(reSection, accordion);
  return { html: replaced, hasFaq: true };
}

const { slug } = Astro.params;

const filePath = join(process.cwd(), "content", "tools", `${slug}.md`);
const raw = await readFile(filePath, "utf-8");
const { data, content } = matter(raw);

const title = String(data.title ?? slug);
const category = data.category ? String(data.category) : "";
const price_model = data.price_model ? String(data.price_model) : "";
const tags = normalizeTags(data.tags);

const heroImage = data.image ? String(data.image) : "";

// если в markdown уже есть картинка — сверху не показываем
const mdHasImage = /!\[[^\]]*\]\([^)]+\)/.test(content) || /<img\s/i.test(content);

let html = String(marked.parse(content));

// убрать первый H1
html = html.replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, "");

// FAQ -> details/summary
const faqRes = faqToAccordion(html);
html = faqRes.html;

// если в итоговом html уже есть <img>, тоже не дублируем hero
const htmlHasImage = /<img\s/i.test(html);
const showHero = Boolean(heroImage) && !mdHasImage && !htmlHasImage;

// в aside показываем только если реально есть что показать
const showAside = showHero || faqRes.hasFaq;
---

<BaseLayout title={`${title} — utildesk`} description={(data.description ? String(data.description) : "")}>
  <p class="breadcrumb"><a href="/tools/">← Tools</a></p>

  <h1>{title}</h1>

  {(category || price_model) ? (
    <div class="pills" aria-label="Meta" style="margin-top:10px;">
      {category ? <span class="pill"><strong>Category</strong> {category}</span> : null}
      {price_model ? <span class="pill"><strong>Preis</strong> {price_model}</span> : null}
    </div>
  ) : null}

  {tags.length ? (
    <div class="pills" aria-label="Tags" style="margin-top:10px;">
      {tags.map((t) => <span class="pill pill--tag">{t}</span>)}
    </div>
  ) : null}

  <div class="tool-hero">
    <article class="article" set:html={html}></article>

    {showAside ? (
      <aside class="aside">
        {showHero ? (
          <div class="aside-card">
            <img class="aside-thumb" src={heroImage} alt={title} loading="lazy" />
            <div class="aside-body">
              <div class="pills" aria-label="Meta">
                {category ? <span class="pill"><strong>Category</strong> {category}</span> : null}
                {price_model ? <span class="pill"><strong>Preis</strong> {price_model}</span> : null}
              </div>
            </div>
          </div>
        ) : null}

        {/* FAQ уже внутри article после преобразования. Тут не дублируем. */}
      </aside>
    ) : null}
  </div>
</BaseLayout>
