---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { marked } from "marked";

export async function getStaticPaths() {
  const toolsDir = join(process.cwd(), "content", "tools");
  const files = (await readdir(toolsDir))
    .filter((f) => f.endsWith(".md") && !f.startsWith("_"));

  const paths = await Promise.all(
    files.map(async (file) => {
      const raw = await readFile(join(toolsDir, file), "utf-8");
      const { data } = matter(raw);
      const slug = String(data.slug ?? file.replace(/\.md$/, ""));
      return { params: { slug } };
    })
  );

  return paths;
}

const { slug } = Astro.params;

const filePath = join(process.cwd(), "content", "tools", `${slug}.md`);
const raw = await readFile(filePath, "utf-8");
const { data, content } = matter(raw);

const official_url = data.official_url ? String(data.official_url) : "";
const affiliate_url = data.affiliate_url ? String(data.affiliate_url) : "";
const provider_url = affiliate_url || official_url || "";

let favicon = null;
try {
  if (provider_url) {
    const u = new URL(provider_url);
    favicon = `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=128`;
  }
} catch {}


const title = String(data.title ?? slug);
const category = data.category ? String(data.category) : null;
const price_model = data.price_model ? String(data.price_model) : null;
const tags = Array.isArray(data.tags) ? data.tags.map(String) : [];

// Helper functions for processing alternatives
const resolveCategoryIcon = (category: string | null, tags: string[]) => {
  const normalizedCategory = category ? category.toLowerCase() : "";
  const normalizedTags = tags.map((tag) => tag.toLowerCase());
  const combined = [normalizedCategory, ...normalizedTags].join(" ");
  if (combined.includes("design") || combined.includes("ui") || combined.includes("ux")) {
    return "design";
  }
  if (combined.includes("automation") || combined.includes("workflow")) {
    return "automation";
  }
  if (combined.includes("ai") || combined.includes("ml") || combined.includes("machine")) {
    return "ai";
  }
  return "generic";
};

const faviconFromUrl = (url: string | null) => {
  if (!url) return null;
  try {
    const u = new URL(url);
    return `https://www.google.com/s2/favicons?sz=128&domain=${encodeURIComponent(u.hostname)}`;
  } catch {
    return null;
  }
};

const slugify = (text: string) => {
  return text
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
};

// Tokenize markdown content
const tokens = marked.lexer(content);

// Find and extract Alternatives section
let alternativesTokens = [];
let alternativesStartIndex = -1;
let alternativesEndIndex = -1;

for (let i = 0; i < tokens.length; i++) {
  const token = tokens[i];
  if (token.type === 'heading' && token.depth === 2) {
    const headingText = token.text.toLowerCase();
    if (headingText.includes('alternativen') || headingText.includes('alternatives')) {
      alternativesStartIndex = i;
      // Find the end of this section (next h2 or end of tokens)
      for (let j = i + 1; j < tokens.length; j++) {
        if (tokens[j].type === 'heading' && tokens[j].depth === 2) {
          alternativesEndIndex = j;
          break;
        }
      }
      if (alternativesEndIndex === -1) {
        alternativesEndIndex = tokens.length;
      }
      alternativesTokens = tokens.slice(alternativesStartIndex, alternativesEndIndex);
      break;
    }
  }
}

// Remove alternatives section from main tokens
let tokensWithoutAlternatives = tokens;
if (alternativesStartIndex !== -1 && alternativesEndIndex !== -1) {
  tokensWithoutAlternatives = [
    ...tokens.slice(0, alternativesStartIndex),
    ...tokens.slice(alternativesEndIndex)
  ];
}

// Extract alternative tool names from the alternatives section
let alternativeNames = [];
if (alternativesTokens.length > 0) {
  for (const token of alternativesTokens) {
    if (token.type === 'list') {
      for (const item of token.items) {
        // Extract text from list item (before colon or in parentheses)
        const itemText = item.text;
        // Try to extract tool name (usually before ":" or up to parentheses)
        let toolName = itemText.split(':')[0].trim();
        // Remove markdown formatting
        toolName = toolName.replace(/\*\*/g, '').replace(/\*/g, '').replace(/`/g, '');
        if (toolName) {
          alternativeNames.push(toolName);
        }
      }
    }
  }
}

// Load all tools to match alternatives
const toolsDir = join(process.cwd(), "content", "tools");
const files = (await readdir(toolsDir))
  .filter((f) => f.endsWith(".md") && !f.startsWith("_"));

const allTools = await Promise.all(
  files.map(async (file) => {
    const full = join(toolsDir, file);
    const raw = await readFile(full, "utf-8");
    const { data } = matter(raw);
    const toolSlug = String(data.slug ?? file.replace(/\.md$/, ""));
    const toolTitle = String(data.title ?? toolSlug);
    const toolCategory = data.category ? String(data.category) : null;
    const toolPriceModel = data.price_model ? String(data.price_model) : null;
    const toolTags = Array.isArray(data.tags) ? data.tags.map(String) : [];
    const toolAffiliateUrl = data.affiliate_url ? String(data.affiliate_url) : null;
    const toolOfficialUrl = data.official_url ? String(data.official_url) : null;
    const providerUrl = toolAffiliateUrl || toolOfficialUrl;
    const iconUrl = faviconFromUrl(providerUrl);

    return {
      slug: toolSlug,
      title: toolTitle,
      titleLower: toolTitle.toLowerCase(),
      category: toolCategory,
      price_model: toolPriceModel,
      tags: toolTags,
      iconUrl,
      fallbackIcon: resolveCategoryIcon(toolCategory, toolTags),
    };
  })
);

// Match alternative names to tools
let alternativeTools = [];
for (const name of alternativeNames) {
  const nameLower = name.toLowerCase();
  const nameSlug = slugify(name);

  // Try exact title match first
  let match = allTools.find(tool => tool.titleLower === nameLower);

  // Try slug match if no exact title match
  if (!match) {
    match = allTools.find(tool => tool.slug === nameSlug);
  }

  // Try partial title match (name contains tool title or vice versa)
  if (!match) {
    match = allTools.find(tool =>
      nameLower.includes(tool.titleLower) || tool.titleLower.includes(nameLower)
    );
  }

  if (match && !alternativeTools.find(t => t.slug === match.slug)) {
    alternativeTools.push(match);
  }

  // Limit to 4 alternatives
  if (alternativeTools.length >= 4) {
    break;
  }
}

// Render Markdown to HTML from tokens without alternatives section
let html = marked.parser(tokensWithoutAlternatives);

// Remove first H1 from markdown to avoid duplicate title
const h1Match = html.match(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i);
if (h1Match) {
  html = html.replace(h1Match[0], '');
}

---

<BaseLayout title={`${title} — Utildesk`} description={`${title} - Informationen, Features und Anwendungsfälle`}>
  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a href="/tools/">← Zurück zu allen Tools</a>
  </nav>

  <!-- Tool Header -->
  <div class="tool-detail-header">
    <h1 class="tool-detail-title">{title}</h1>

    <!-- Badges -->
    {(category || price_model || tags.length > 0) && (
      <div class="tool-detail-badges">
        {category && (
          <span class="badge badge-category">{category}</span>
        )}
        {price_model && (
          <span class="badge badge-price">{price_model}</span>
        )}
        {tags.map((tag) => (
          <a class="badge badge-tag" href={`/tools/?tag=${encodeURIComponent(tag)}`}>{tag}</a>
        ))}
      </div>
    )}
  </div>

  <!-- Article Content -->
  <article class="card article">
  <div class="article-body">
    {favicon && provider_url ? (
      <a class="tool-float-logo" href={provider_url} target="_blank" rel="noopener noreferrer" title="Zum Anbieter">
        <img src={favicon} alt={`${title} favicon`} loading="lazy" />
      </a>
    ) : favicon ? (
      <span class="tool-float-logo" aria-hidden="true">
        <img src={favicon} alt="" loading="lazy" />
      </span>
    ) : null}

    <div set:html={html}></div>
  </div>
</article>

  {alternativeTools.length > 0 && (
    <section class="tool-alternatives">
      <h2 class="alternatives-heading">Alternativen</h2>
      <div class="alternatives-grid">
        {alternativeTools.map((tool) => (
          <a href={`/tools/${tool.slug}/`} class="alternative-card">
            <div class="alternative-card-icon">
              {tool.iconUrl ? (
                <img src={tool.iconUrl} alt={tool.title} loading="lazy" />
              ) : tool.fallbackIcon === "ai" ? (
                <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                  <path
                    d="M9 3a1 1 0 0 1 1 1v1.1a6.002 6.002 0 0 1 4 0V4a1 1 0 1 1 2 0v2.1a6.002 6.002 0 0 1 3 5.2V13a1 1 0 0 1-1 1h-1.1a6.002 6.002 0 0 1-5.2 3V19a1 1 0 1 1-2 0v-2.1a6.002 6.002 0 0 1-5.2-3H4a1 1 0 0 1-1-1v-1.7a6.002 6.002 0 0 1 3-5.2V4a1 1 0 0 1 2 0v1.1a6.01 6.01 0 0 1 1-.1Zm3 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"
                    fill="currentColor"
                  />
                </svg>
              ) : tool.fallbackIcon === "automation" ? (
                <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                  <path
                    d="M7 4a3 3 0 0 1 3 3v1h4V7a3 3 0 1 1 6 0v3a3 3 0 0 1-3 3h-1v2h1a3 3 0 1 1-3 3v-1h-4v1a3 3 0 1 1-6 0v-3a3 3 0 0 1 3-3h1v-2H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3Zm0 2a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h3v4H7a1 1 0 0 0-1 1v3a1 1 0 1 0 2 0v-1h8v1a1 1 0 1 0 2 0v-3a1 1 0 0 0-1-1h-3v-4h3a1 1 0 0 0 1-1V7a1 1 0 1 0-2 0v1H8V7a1 1 0 0 0-1-1Z"
                    fill="currentColor"
                  />
                </svg>
              ) : tool.fallbackIcon === "design" ? (
                <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                  <path
                    d="M6 3a3 3 0 0 0-3 3v9a6 6 0 0 0 12 0V6a3 3 0 0 0-3-3H6Zm0 2h6a1 1 0 0 1 1 1v9a4 4 0 1 1-8 0V6a1 1 0 0 1 1-1Zm12 2a3 3 0 0 1 3 3v5a6 6 0 0 1-6 6h-1.5a7.97 7.97 0 0 0 2.5-6V7h2Z"
                    fill="currentColor"
                  />
                </svg>
              ) : (
                <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                  <path
                    d="M5 5h14a2 2 0 0 1 2 2v3H3V7a2 2 0 0 1 2-2Zm-2 7h18v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm4 2v3h2v-3H7Zm4 0v3h6v-3h-6Z"
                    fill="currentColor"
                  />
                </svg>
              )}
            </div>
            <div class="alternative-card-body">
              <h3 class="alternative-card-title">{tool.title}</h3>
              {(tool.category || tool.price_model) && (
                <div class="alternative-card-meta">
                  {tool.category && <span class="alternative-meta-item">{tool.category}</span>}
                  {tool.price_model && <span class="alternative-meta-item">{tool.price_model}</span>}
                </div>
              )}
            </div>
          </a>
        ))}
      </div>
    </section>
  )}

  <style>
    .tool-alternatives {
      margin-top: 48px;
    }

    .alternatives-heading {
      font-size: 1.75rem;
      font-weight: 600;
      margin-bottom: 24px;
      color: var(--text);
    }

    .alternatives-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }

    .alternative-card {
      display: flex;
      flex-direction: column;
      padding: 20px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg);
      text-decoration: none;
      color: var(--text);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .alternative-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .alternative-card-icon {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
    }

    .alternative-card-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .alternative-card-icon svg {
      width: 32px;
      height: 32px;
    }

    .alternative-card-body {
      flex: 1;
    }

    .alternative-card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: var(--text);
    }

    .alternative-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 0.875rem;
    }

    .alternative-meta-item {
      padding: 4px 10px;
      border-radius: 4px;
      background: var(--bg-secondary);
      color: var(--text-muted);
    }
  </style>
</BaseLayout>
