---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { marked } from "marked";
import { resolveLocalLogo } from "../../lib/resolveLogoPath";
import { CATEGORIES } from "../../lib/categories";

export async function getStaticPaths() {
  const toolsDir = join(process.cwd(), "content", "tools");
  const files = (await readdir(toolsDir))
    .filter((f) => f.endsWith(".md") && !f.startsWith("_"));

  const paths = await Promise.all(
    files.map(async (file) => {
      const raw = await readFile(join(toolsDir, file), "utf-8");
      const { data } = matter(raw);
      const disabled = data.disabled === true || String(data.disabled || "").toLowerCase() === "true";
      if (disabled) return null;
      const slug = String(data.slug ?? file.replace(/\.md$/, ""));
      return { params: { slug } };
    })
  );

  return paths.filter(Boolean);
}

const { slug } = Astro.params;

const filePath = join(process.cwd(), "content", "tools", `${slug}.md`);
const raw = await readFile(filePath, "utf-8");
const { data, content } = matter(raw);

const official_url = data.official_url ? String(data.official_url) : "";
const affiliate_url = data.affiliate_url ? String(data.affiliate_url) : "";
const brandLogo = data.brandLogo ? String(data.brandLogo) : null;
const provider_url = affiliate_url || official_url || "";

const localLogo = resolveLocalLogo(slug);
let faviconLogo = null;
try {
  if (provider_url) {
    const u = new URL(provider_url);
    faviconLogo = `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=128`;
  }
} catch {}

const logoUrl = brandLogo || localLogo || faviconLogo;


const title = String(data.title ?? slug);
const category = data.category ? String(data.category) : null;
const price_model = data.price_model ? String(data.price_model) : null;
const tags = Array.isArray(data.tags) ? data.tags.map(String) : [];
const norm = (s) => String(s ?? "").trim().toLowerCase();
const categoryNorm = norm(category);
const seen = new Set();
const displayTags = (tags ?? [])
  .map(String)
  .filter((t) => {
    const n = norm(t);
    if (!n) return false;
    if (categoryNorm && n === categoryNorm) return false;
    if (seen.has(n)) return false;
    seen.add(n);
    return true;
  });

// Find primary category (first matching category from CATEGORIES)
const normalizedTags = tags.map(t => String(t).toLowerCase());
const primaryCategory = CATEGORIES.find((cat) =>
  normalizedTags.some((tag) => cat.matchTags.includes(tag))
);

// Render Markdown to HTML

// Remove the Alternativen/Alternatives section from the main markdown content so it won't appear in the article text
const contentWithoutAlternatives = content.replace(
  /(?:^|\n)#{1,3}\s+(Alternativen|Alternatives?)\b[^\n]*\n[\s\S]*?(?=\n#{1,3}\s|\s*$)/i,
  ""
).trim();
let html = marked.parse(contentWithoutAlternatives);

// Remove first H1 from markdown to avoid duplicate title
html = String(html).replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, "");

// ── Alternatives helpers ───────────────────────────────────────────────────
const stripMd = (text: string) =>
  text
    .replace(/!\[[^\]]*]\([^)]*\)/g, "")
    .replace(/\[[^\]]*]\([^)]*\)/g, "$1")
    .replace(/[`*_>#-]/g, "")
    .replace(/\s+/g, " ")
    .trim();

const getExcerpt = (md: string) => {
  for (const p of md.split(/\n\s*\n/)) {
    if (p.trim().startsWith("#")) continue;
    const cleaned = stripMd(p);
    if (cleaned) return cleaned;
  }
  return "";
};

const faviconFrom = (url: string | null) => {
  if (!url) return null;
  try {
    const u = new URL(url);
    return `https://www.google.com/s2/favicons?sz=128&domain=${encodeURIComponent(u.hostname)}`;
  } catch { return null; }
};

const iconType = (cat: string | null, tgs: string[]) => {
  const c = [cat?.toLowerCase() ?? "", ...tgs.map((t) => t.toLowerCase())].join(" ");
  if (c.includes("design") || c.includes("ui") || c.includes("ux")) return "design";
  if (c.includes("automation") || c.includes("workflow")) return "automation";
  if (c.includes("ai") || c.includes("ml") || c.includes("machine")) return "ai";
  return "generic";
};

const normalizeAltName = (value: string) =>
  String(value ?? "")
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, "$1")
    .replace(/[`*_]/g, "")
    .replace(/\s+/g, " ")
    .trim()
    .toLowerCase();

const normalizeAltNameFuzzy = (value: string) =>
  normalizeAltName(value)
    .replace(/\([^)]*\)/g, " ")
    .replace(/\b(ai|tool|app|platform)\b/g, " ")
    .replace(/\s+/g, " ")
    .trim();

const parseAltItem = (item: string) => {
  const internalLink = item.match(/^\[([^\]]+)\]\(\/tools\/([^/)\s]+)\/?\)\s*(?::\s*(.*))?$/);
  if (internalLink) {
    return { kind: "internal_link" as const, name: internalLink[1], slug: internalLink[2] };
  }

  const linked = item.match(/^\[([^\]]+)\]\(([^)]+)\)\s*(?::\s*(.*))?$/);
  if (linked) {
    return { kind: "linked" as const, name: linked[1] };
  }

  const boldColonInside = item.match(/^\*\*([^*]+?)\s*:\s*\*\*\s*(.+)$/);
  if (boldColonInside) {
    return { kind: "bold" as const, name: boldColonInside[1] };
  }

  const boldWithSeparator = item.match(/^\s*\*\*([^*]+)\*\*\s*(?::|–|—|-)\s*(.+)?$/i);
  if (boldWithSeparator) {
    return { kind: "bold" as const, name: boldWithSeparator[1] };
  }

  const bold = item.match(/^\*\*([^*]+?)\*\*\s*:\s*(.+)$/);
  if (bold) {
    return { kind: "bold" as const, name: bold[1] };
  }

  const plainWithSeparator = item.match(/^\s*([^:–—-][^:–—-]{1,80})\s*(?::|–|—|-)\s*(.+)?$/);
  if (plainWithSeparator) {
    return { kind: "plain" as const, name: plainWithSeparator[1] };
  }

  const plain = item.match(/^([^:]+?)\s*:\s*(.+)$/);
  if (plain) {
    return { kind: "plain" as const, name: plain[1] };
  }

  return null;
};

// ── Extract raw list items from the "Alternatives" section ─────────────────
const altSection = content.match(/(?:^|\r?\n)#{1,3}\s+(Alternativen|Alternatives?)\b[^\r\n]*\r?\n([\s\S]*?)(?=\r?\n#{1,3}\s|\s*$)/i);
const rawAltItems: string[] = altSection
  ? (altSection[2].match(/^[-*]\s+(.+)$/gm) ?? []).map((l) => l.replace(/^[-*]\s+/, "").trim())
  : [];

// ── Load all tool metadata (for matching + rendering) ──────────────────────
const toolsDir = join(process.cwd(), "content", "tools");
const allTools = await Promise.all(
  (await readdir(toolsDir))
    .filter((f) => f.endsWith(".md") && !f.startsWith("_"))
    .map(async (file) => {
      const { data: d, content: c } = matter(await readFile(join(toolsDir, file), "utf-8"));
      const s = String(d.slug ?? file.replace(/\.md$/, ""));
      const t = String(d.title ?? s);
      const cat = d.category ? String(d.category) : null;
      const pm = d.price_model ? String(d.price_model) : null;
      const bLogo = d.brandLogo ? String(d.brandLogo) : null;
      const pUrl = d.affiliate_url ? String(d.affiliate_url) : d.official_url ? String(d.official_url) : null;
      const tgs = Array.isArray(d.tags) ? d.tags.map(String) : [];
      const disabled = d.disabled === true || String(d.disabled || "").toLowerCase() === "true";
      const desc = d.description ? String(d.description)
        : d.summary ? String(d.summary)
        : d.excerpt ? String(d.excerpt)
        : d.tagline ? String(d.tagline)
        : "";
      const localAltLogo = resolveLocalLogo(s);
      const faviconAltLogo = faviconFrom(pUrl);
      return {
        slug: s, title: t, category: cat, price_model: pm,
        iconUrl: bLogo || localAltLogo || faviconAltLogo, tags: tgs,
        excerpt: desc || getExcerpt(c),
        fallbackIcon: iconType(cat, tgs),
        disabled,
      };
    })
);

const enabledTools = allTools.filter((t) => !t.disabled);
const enabledBySlug = new Map(enabledTools.map((t) => [t.slug, t]));
const enabledByNormTitle = new Map(enabledTools.map((t) => [normalizeAltName(t.title), t]));
const enabledByNormTitleFuzzy = new Map(enabledTools.map((t) => [normalizeAltNameFuzzy(t.title), t]));

// ── Match alternatives from multiple markdown formats, preserve input order ─
const alternatives = rawAltItems.reduce<typeof enabledTools>((acc, item) => {
  const parsed = parseAltItem(item);
  if (!parsed) return acc;

  let tool = null;
  if (parsed.kind === "internal_link") {
    tool = enabledBySlug.get(parsed.slug) ?? null;
  } else {
    tool = enabledByNormTitle.get(normalizeAltName(parsed.name)) ?? null;
    if (!tool) {
      tool = enabledByNormTitleFuzzy.get(normalizeAltNameFuzzy(parsed.name)) ?? null;
    }
  }

  if (!tool) return acc;
  if (tool.slug === slug) return acc;
  if (acc.some((x) => x.slug === tool.slug)) return acc;

  acc.push(tool);
  return acc;
}, []);
const alternativesTop = alternatives.slice(0, 3);
---

<BaseLayout title={`${title} — Utildesk`} description={`${title} - Informationen, Features und Anwendungsfälle`}>
  <Fragment slot="head">
    <link rel="canonical" href={`https://tools.utildesk.de/tools/${slug}/`} />
  </Fragment>

  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a href="/tools/">← Zurück zu allen Tools</a>
  </nav>

  <!-- Tool Header -->
  <div class="tool-detail-header">
    <h1 class="tool-detail-title">{title}</h1>

    <!-- Badges -->
    {(category || price_model || tags.length > 0) && (
      <div class="tool-detail-badges">
        {category && (
          <span class="badge badge-category">{category}</span>
        )}
        {price_model && (
          <span class="badge badge-price">{price_model}</span>
        )}
        {displayTags.map((tag) => (
          <a class="badge badge-tag" href={`/tools/?tag=${encodeURIComponent(tag)}`}>{tag}</a>
        ))}
      </div>
    )}

    <!-- Primary Category Link -->
    {primaryCategory && (
      <div class="tool-category-link">
        <span class="category-label">Kategorie:</span>
        <a href={`/category/${primaryCategory.slug}/`} class="category-link-anchor">{primaryCategory.title}</a>
      </div>
    )}
  </div>

  <!-- Article Content -->
  <article class="card article">
  <div class="article-body">
    {logoUrl && provider_url ? (
      <a class="tool-float-logo" href={provider_url} target="_blank" rel="noopener noreferrer" title="Zum Anbieter">
        <img src={logoUrl} alt={`${title} favicon`} loading="lazy" />
      </a>
    ) : logoUrl ? (
      <span class="tool-float-logo" aria-hidden="true">
        <img src={logoUrl} alt="" loading="lazy" />
      </span>
    ) : null}

    <div set:html={html}></div>
  </div>
</article>

  <!-- Alternatives — rendered after article, using exact /tools card markup -->
  {alternativesTop.length > 0 && (
    <section>
      <h2 style="margin-top: 2.5rem; margin-bottom: 1rem;">Alternativen</h2>
      <div class="alt-grid">
        {alternativesTop.map((tool) => (
          <a
            href={`/tools/${tool.slug}/`}
            class="card tool-card"
          >
            <div class="tool-header">
              <div class="tool-image">
                {tool.iconUrl ? (
                  <span class="tool-card-logo">
                    <img src={tool.iconUrl} alt={tool.title} loading="lazy" />
                  </span>
                ) : tool.fallbackIcon === "ai" ? (
                  <span class="tool-card-logo" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                      <path
                        d="M9 3a1 1 0 0 1 1 1v1.1a6.002 6.002 0 0 1 4 0V4a1 1 0 1 1 2 0v2.1a6.002 6.002 0 0 1 3 5.2V13a1 1 0 0 1-1 1h-1.1a6.002 6.002 0 0 1-5.2 3V19a1 1 0 1 1-2 0v-2.1a6.002 6.002 0 0 1-5.2-3H4a1 1 0 0 1-1-1v-1.7a6.002 6.002 0 0 1 3-5.2V4a1 1 0 0 1 2 0v1.1a6.01 6.01 0 0 1 1-.1Zm3 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                ) : tool.fallbackIcon === "automation" ? (
                  <span class="tool-card-logo" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                      <path
                        d="M7 4a3 3 0 0 1 3 3v1h4V7a3 3 0 1 1 6 0v3a3 3 0 0 1-3 3h-1v2h1a3 3 0 1 1-3 3v-1h-4v1a3 3 0 1 1-6 0v-3a3 3 0 0 1 3-3h1v-2H7a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3Zm0 2a1 1 0 0 0-1 1v3a1 1 0 0 0 1 1h3v4H7a1 1 0 0 0-1 1v3a1 1 0 1 0 2 0v-1h8v1a1 1 0 1 0 2 0v-3a1 1 0 0 0-1-1h-3v-4h3a1 1 0 0 0 1-1V7a1 1 0 1 0-2 0v1H8V7a1 1 0 0 0-1-1Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                ) : tool.fallbackIcon === "design" ? (
                  <span class="tool-card-logo" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                      <path
                        d="M6 3a3 3 0 0 0-3 3v9a6 6 0 0 0 12 0V6a3 3 0 0 0-3-3H6Zm0 2h6a1 1 0 0 1 1 1v9a4 4 0 1 1-8 0V6a1 1 0 0 1 1-1Zm12 2a3 3 0 0 1 3 3v5a6 6 0 0 1-6 6h-1.5a7.97 7.97 0 0 0 2.5-6V7h2Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                ) : (
                  <span class="tool-card-logo" aria-hidden="true">
                    <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                      <path
                        d="M5 5h14a2 2 0 0 1 2 2v3H3V7a2 2 0 0 1 2-2Zm-2 7h18v5a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-5Zm4 2v3h2v-3H7Zm4 0v3h6v-3h-6Z"
                        fill="currentColor"
                      />
                    </svg>
                  </span>
                )}
              </div>
              <div class="tool-info">
                <h3 class="tool-title">{tool.title}</h3>
                <p class="tools-desc">{tool.excerpt || "Kurzbeschreibung folgt."}</p>
              </div>
            </div>
            <div class="tool-badges">
              {tool.category && (
                <span class="badge badge-category">{tool.category}</span>
              )}
              {tool.price_model && (
                <span class="badge badge-price">{tool.price_model}</span>
              )}
            </div>
          </a>
        ))}
      </div>
    </section>
  )}
</BaseLayout>

<style>
  .tool-category-link {
    margin-top: 16px;
    font-size: 0.9375rem;
    line-height: 1.5;
  }

  .category-label {
    color: var(--text-muted);
    margin-right: 8px;
  }

  .category-link-anchor {
    color: var(--accent);
    text-decoration: none;
    font-weight: 500;
  }

  .category-link-anchor:hover {
    text-decoration: underline;
  }

  .alt-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  @media (min-width: 700px) {
    .alt-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  @media (min-width: 1024px) {
    .alt-grid {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }
</style>
