---
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { marked } from "marked";

export async function getStaticPaths() {
  const toolsDir = join(process.cwd(), "content", "tools");
  const files = (await readdir(toolsDir)).filter(
    (f) => f.endsWith(".md") && !f.startsWith("_")
  );

  const paths = await Promise.all(
    files.map(async (file) => {
      const raw = await readFile(join(toolsDir, file), "utf-8");
      const { data } = matter(raw);
      const slug = String(data.slug ?? file.replace(/\.md$/, ""));
      return { params: { slug } };
    })
  );

  return paths;
}

function normalizeTags(value) {
  if (!value) return [];
  if (Array.isArray(value)) return value.map(String).map((s) => s.trim()).filter(Boolean);
  if (typeof value === "string") {
    return value.split(",").map((s) => s.trim()).filter(Boolean);
  }
  return [];
}

/**
 * Convert a "FAQ" section rendered by marked:
 * <h2>FAQ</h2> then repeated <h3>Question</h3> ...answer html...
 * into <details>/<summary>.
 */
function faqToAccordion(html) {
  const reSection = /<h2[^>]*>\s*FAQ\s*<\/h2>([\s\S]*?)(?=<h2[^>]*>|$)/i;
  const m = html.match(reSection);
  if (!m) return html;

  const sectionBody = m[1];

  // Split by <h3>...</h3>
  const parts = sectionBody.split(/<h3[^>]*>/i);
  if (parts.length < 2) return html;

  // parts[0] is preface before first h3
  const items = [];
  for (let i = 1; i < parts.length; i++) {
    const chunk = parts[i];
    const endTitle = chunk.search(/<\/h3>/i);
    if (endTitle === -1) continue;

    const q = chunk.slice(0, endTitle).replace(/<[^>]+>/g, "").trim();
    const a = chunk.slice(endTitle).replace(/<\/h3>/i, "").trim();

    if (!q) continue;

    items.push(
      `<details class="faq-item">
         <summary class="faq-question">${q}</summary>
         <div class="faq-answer">${a}</div>
       </details>`
    );
  }

  const accordion =
    `<section class="faq-accordion">` +
    items.join("") +
    `</section>`;

  // Replace entire FAQ section (including its body) with h2 + accordion
  const replaced = html.replace(reSection, `<h2>FAQ</h2>${accordion}`);
  return replaced;
}

const { slug } = Astro.params;

const filePath = join(process.cwd(), "content", "tools", `${slug}.md`);
const raw = await readFile(filePath, "utf-8");
const { data, content } = matter(raw);

const title = String(data.title ?? slug);
const category = data.category ? String(data.category) : "";
const price_model = data.price_model ? String(data.price_model) : "";
const tags = normalizeTags(data.tags);

let html = marked.parse(content);

// Remove first H1 from markdown to avoid duplicate title
html = String(html).replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, "");

// Convert FAQ section to accordion
html = faqToAccordion(html);
---

<html lang="de">
  <head>
    <link rel="stylesheet" href="/styles/global.css" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
  </head>

  <body>
    <main>
      <p class="breadcrumb"><a href="/tools/">‚Üê Tools</a></p>

      <h1 class="h1">{title}</h1>

      {(category || price_model) ? (
        <div class="pills" aria-label="Meta">
          {category ? <span class="pill">{category}</span> : null}
          {price_model ? <span class="pill">{price_model}</span> : null}
        </div>
      ) : null}

      {tags.length ? (
        <div class="pills" style="margin-top:10px;" aria-label="Tags">
          {tags.map((t) => <span class="pill pill--tag">{t}</span>)}
        </div>
      ) : null}

      {data.image ? (
        <img src={String(data.image)} alt={title} style="max-width: 100%; height: auto; margin-top: 14px; border-radius: 14px; border: 1px solid var(--border);" />
      ) : null}

      <article class="card article" set:html={html}></article>
    </main>
  </body>
</html>
