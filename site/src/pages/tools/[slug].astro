---
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { marked } from "marked";

export async function getStaticPaths() {
  const toolsDir = join(process.cwd(), "content", "tools");
  const files = (await readdir(toolsDir))
    .filter((f) => f.endsWith(".md") && !f.startsWith("_"));

  const paths = await Promise.all(
    files.map(async (file) => {
      const raw = await readFile(join(toolsDir, file), "utf-8");
      const { data } = matter(raw);
      const slug = String(data.slug ?? file.replace(/\.md$/, ""));
      return { params: { slug } };
    })
  );

  return paths;
}

const { slug } = Astro.params;

const filePath = join(process.cwd(), "content", "tools", `${slug}.md`);
const raw = await readFile(filePath, "utf-8");
const { data, content } = matter(raw);

const title = String(data.title ?? slug);

// ВАЖНО: рендер Markdown в HTML
let html = marked.parse(content);

// Remove first H1 from markdown to avoid duplicate title
html = String(html).replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, "");

// Convert FAQ section to accordion
function convertFaqToAccordion(htmlContent: string): string {
  // Find FAQ section (h2 with "FAQ" text)
  const faqRegex = /<h2[^>]*>FAQ<\/h2>([\s\S]*?)(?=<h2|$)/i;
  const match = htmlContent.match(faqRegex);

  if (!match) return htmlContent;

  const faqContent = match[1];
  const beforeFaq = htmlContent.substring(0, match.index);
  const afterFaq = htmlContent.substring(match.index! + match[0].length);

  // Parse FAQ items (question in <strong> followed by answer in <p>)
  let accordionHtml = '<div class="faq-accordion">\n';

  // Match pattern: <p><strong>Question</strong><br>Answer</p>
  // or <p><strong>Question</strong></p><p>Answer</p>
  const questionPattern = /<p><strong>(.+?)<\/strong>\s*(?:<br\s*\/?>)?\s*([\s\S]*?)<\/p>/g;
  let qMatch;

  while ((qMatch = questionPattern.exec(faqContent)) !== null) {
    const question = qMatch[1].trim();
    const answer = qMatch[2].trim();

    accordionHtml += `  <details class="faq-item">
    <summary class="faq-question">${question}</summary>
    <div class="faq-answer">${answer || ''}</div>
  </details>\n`;
  }

  accordionHtml += '</div>';

  return beforeFaq + '<h2>FAQ</h2>\n' + accordionHtml + afterFaq;
}

html = convertFaqToAccordion(html);
---

<html lang="de">
  <head>
    <link rel="stylesheet" href="/styles/global.css" />
<meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
  </head>
  <body>
    <main>
      <p class="breadcrumb"><a href="/tools/">← Tools</a></p>
      <h1 class="h1">{title}</h1>

      {data.image ? (
        <img src={String(data.image)} alt={title} style="max-width: 100%; height: auto;" />
      ) : null}

      <article class="card article" set:html={html}></article>
    </main>
  </body>
</html>
