---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { marked } from "marked";

export async function getStaticPaths() {
  const toolsDir = join(process.cwd(), "content", "tools");
  const files = (await readdir(toolsDir))
    .filter((f) => f.endsWith(".md") && !f.startsWith("_"));

  const paths = await Promise.all(
    files.map(async (file) => {
      const raw = await readFile(join(toolsDir, file), "utf-8");
      const { data } = matter(raw);
      const slug = String(data.slug ?? file.replace(/\.md$/, ""));
      return { params: { slug } };
    })
  );

  return paths;
}

const { slug } = Astro.params;

const filePath = join(process.cwd(), "content", "tools", `${slug}.md`);
const raw = await readFile(filePath, "utf-8");
const { data, content } = matter(raw);

const title = String(data.title ?? slug);
const image = data.image ? String(data.image) : null;
const category = data.category ? String(data.category) : null;
const price_model = data.price_model ? String(data.price_model) : null;
const tags = data.tags ? (Array.isArray(data.tags) ? data.tags : [data.tags]) : [];

// ВАЖНО: рендер Markdown в HTML
let html = marked.parse(content);

// Remove first H1 from markdown to avoid duplicate title
html = String(html).replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, "");
---

<BaseLayout title={title + " — Utildesk"} description={title}>
  <div class="tool-header">
    <p class="breadcrumb"><a href="/tools/">← Zurück zu Tools</a></p>

    <div class="tool-title-section">
      {image ? (
        <div class="tool-header-image">
          <img src={image} alt={title} />
        </div>
      ) : null}

      <div class="tool-header-content">
        <h1 class="hero-title">{title}</h1>

        <div class="tool-meta-badges">
          {category ? (
            <span class="tool-badge badge-category">{category}</span>
          ) : null}
          {price_model ? (
            <span class="tool-badge badge-price">{price_model}</span>
          ) : null}
          {tags.map((tag) => (
            <span class="tool-badge badge-tag">{String(tag)}</span>
          ))}
        </div>
      </div>
    </div>
  </div>

  <article class="card article" set:html={html}></article>
</BaseLayout>
