---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { marked } from "marked";

export async function getStaticPaths() {
  const toolsDir = join(process.cwd(), "content", "tools");
  const files = (await readdir(toolsDir))
    .filter((f) => f.endsWith(".md") && !f.startsWith("_"));

  const paths = await Promise.all(
    files.map(async (file) => {
      const raw = await readFile(join(toolsDir, file), "utf-8");
      const { data } = matter(raw);
      const slug = String(data.slug ?? file.replace(/\.md$/, ""));
      return { params: { slug } };
    })
  );

  return paths;
}

const { slug } = Astro.params;

const filePath = join(process.cwd(), "content", "tools", `${slug}.md`);
const raw = await readFile(filePath, "utf-8");
const { data, content } = matter(raw);

const title = String(data.title ?? slug);
const category = data.category ? String(data.category) : null;
const price_model = data.price_model ? String(data.price_model) : null;
const tags = Array.isArray(data.tags) ? data.tags.map(String) : [];
const image = data.image ? String(data.image) : null;

// Render Markdown to HTML
let html = marked.parse(content);

// Remove first H1 from markdown to avoid duplicate title
html = String(html).replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, "");

// Remove image from markdown if it exists (we show it separately)
if (image) {
  const imgPattern = new RegExp(`<p>\\s*<img[^>]+src=["']${image.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["'][^>]*>\\s*</p>`, 'gi');
  html = String(html).replace(imgPattern, "");
}
---

<BaseLayout title={`${title} — Utildesk`} description={`${title} - Informationen, Features und Anwendungsfälle`}>
  <!-- Breadcrumb -->
  <nav class="breadcrumb">
    <a href="/tools/">← Zurück zu allen Tools</a>
  </nav>

  <!-- Tool Header -->
  <div class="tool-detail-header">
    <h1 class="tool-detail-title">{title}</h1>

    <!-- Badges -->
    {(category || price_model || tags.length > 0) && (
      <div class="tool-detail-badges">
        {category && (
          <span class="badge badge-category">{category}</span>
        )}
        {price_model && (
          <span class="badge badge-price">{price_model}</span>
        )}
        {tags.map((tag) => (
          <span class="badge badge-tag">{tag}</span>
        ))}
      </div>
    )}

    <!-- Image -->
    {image && (
      <img
        src={image}
        alt={title}
        class="tool-detail-image"
      />
    )}
  </div>

  <!-- Article Content -->
  <article class="card article" set:html={html}></article>
</BaseLayout>
