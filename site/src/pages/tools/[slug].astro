---
import { readdir, readFile } from "node:fs/promises";
import { join } from "node:path";
import matter from "gray-matter";
import { marked } from "marked";
import BaseLayout from "../../layouts/BaseLayout.astro";

export async function getStaticPaths() {
  const toolsDir = join(process.cwd(), "content", "tools");
  const files = (await readdir(toolsDir)).filter(
    (f) => f.endsWith(".md") && !f.startsWith("_")
  );

  const paths = await Promise.all(
    files.map(async (file) => {
      const raw = await readFile(join(toolsDir, file), "utf-8");
      const { data } = matter(raw);
      const slug = String(data.slug ?? file.replace(/\.md$/, ""));
      return { params: { slug } };
    })
  );

  return paths;
}

function normalizeTags(value) {
  if (!value) return [];
  if (Array.isArray(value)) return value.map(String).map((s) => s.trim()).filter(Boolean);
  if (typeof value === "string") return value.split(",").map((s) => s.trim()).filter(Boolean);
  return [];
}

/**
 * Convert a "FAQ" section rendered by marked:
 * <h2>FAQ</h2> then repeated <h3>Question</h3> ...answer html...
 * into <details>/<summary>.
 */
function faqToAccordion(html) {
  const reSection = /<h2[^>]*>\s*FAQ\s*<\/h2>([\s\S]*?)(?=<h2[^>]*>|$)/i;
  const m = html.match(reSection);
  if (!m) return html;

  const sectionBody = m[1];
  const parts = sectionBody.split(/<h3[^>]*>/i);
  if (parts.length < 2) return html;

  const items = [];
  for (let i = 1; i < parts.length; i++) {
    const chunk = parts[i];
    const endTitle = chunk.search(/<\/h3>/i);
    if (endTitle === -1) continue;

    const q = chunk.slice(0, endTitle).replace(/<[^>]+>/g, "").trim();
    const a = chunk.slice(endTitle).replace(/<\/h3>/i, "").trim();
    if (!q) continue;

    items.push(
      `<details>
         <summary>${q}</summary>
         <div class="answer">${a}</div>
       </details>`
    );
  }

  const accordion = `<div class="faq">${items.join("")}</div>`;
  return html.replace(reSection, `<h2>FAQ</h2>${accordion}`);
}

const { slug } = Astro.params;

const filePath = join(process.cwd(), "content", "tools", `${slug}.md`);
const raw = await readFile(filePath, "utf-8");
const { data, content } = matter(raw);

const title = String(data.title ?? slug);
const category = data.category ? String(data.category) : "";
const price_model = data.price_model ? String(data.price_model) : "";
const tags = normalizeTags(data.tags);

const heroImage = data.image ? String(data.image) : "";

// если в markdown уже есть картинка — сверху не показываем
const mdHasImage = /!\[[^\]]*\]\([^)]+\)/.test(content) || /<img\s/i.test(content);

let html = marked.parse(content);

// убрать первый H1, чтобы не дублировать заголовок страницы
html = String(html).replace(/<h1[^>]*>[\s\S]*?<\/h1>\s*/i, "");

// FAQ -> <details>/<summary>
html = faqToAccordion(html);

// если в итоговом html уже есть <img>, тоже не дублируем hero
const htmlHasImage = /<img\s/i.test(html);
const showHero = Boolean(heroImage) && !mdHasImage && !htmlHasImage;
---

<BaseLayout title={`${title} — utildesk`} description={(data.description ? String(data.description) : "")}>
  <p class="breadcrumb"><a href="/tools/">← Tools</a></p>

  <h1>{title}</h1>

  {(category || price_model) ? (
    <div class="pills" aria-label="Meta" style="margin-top:10px;">
      {category ? <span class="pill"><strong>Category</strong> {category}</span> : null}
      {price_model ? <span class="pill"><strong>Preis</strong> {price_model}</span> : null}
    </div>
  ) : null}

  {tags.length ? (
    <div class="pills" aria-label="Tags" style="margin-top:10px;">
      {tags.map((t) => <span class="pill pill--tag">{t}</span>)}
    </div>
  ) : null}

  <div class="tool-hero">
    <article class="article" set:html={html}></article>

    <aside class="hero-box">
      {showHero ? <img class="thumb" src={heroImage} alt={title} loading="lazy" /> : null}
      <div class="hero-body">
        <p class="lead" style="margin:0;">
          {data.subtitle ? String(data.subtitle) : "Kurzinfo: Details stehen im Artikel."}
        </p>
      </div>
    </aside>
  </div>
</BaseLayout>
