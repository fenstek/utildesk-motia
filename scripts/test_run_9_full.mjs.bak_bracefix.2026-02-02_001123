#!/usr/bin/env node
/**
 * Orchestrator: process N NEW tools end-to-end
 *
 * Usage:
 *   node scripts/test_run_9_full.mjs 9
 */
import { spawnSync } from 'node:child_process';
import fs from 'node:fs';

const COUNT = Math.max(1, Math.min(50, Number(process.argv[2] || 9)));
const TOOL_JSON = '/tmp/utildesk_current_tool.json';

function die(msg){
  console.error(`\n[FAIL] ${msg}\n`);
  process.exit(1);
}

function runCapture(cmd, args){
  const r = spawnSync(cmd, args, { encoding:'utf8' });
  if (r.status !== 0) {
    console.error(r.stderr || r.stdout || '');
    die(`${cmd} ${args.join(' ')}`);
  }
  return (r.stdout || '').trim();
}

function runInherit(cmd, args){
  const r = spawnSync(cmd, args, { stdio:'inherit' });
  if (r.status !== 0) {
    die(`${cmd} ${args.join(' ')}`);
  }
}

function readRowNumber(toolJsonText){
  try{
    const j = JSON.parse(toolJsonText);
    const rn = j?.row_number ?? j?.item?.row_number;
if(!rn) return null;
    return Number(rn);
  }catch{
    return null;
  }
}

console.log(`[INFO] Processing ${COUNT} NEW tools`);

for (let i = 0; i < COUNT; i++){
  console.log(`\n[STEP] ${i+1}/${COUNT}`);

  // 1) get next NEW tool (this script itself sets IN_PROGRESS)
  const out = runCapture('node', ['scripts/sheet_get_next_new.mjs']);
  if(!out) die('sheet_get_next_new.mjs returned empty output');
  if(!out.includes('"found": true')) die(`No NEW tools found or unexpected output:\n${out}`);
    // Normalize tool JSON so downstream scripts can read slug/title at top-level
    let parsed;
    try {
      parsed = JSON.parse(out);
    } catch (e) {
      die('sheet_get_next_new.mjs returned invalid JSON');
    }
    const item = parsed?.item ?? parsed;
    const norm = {
      ...item,
      title: item?.title ?? item?.topic ?? item?.slug
    };
    fs.writeFileSync(TOOL_JSON, JSON.stringify(norm, null, 2) + '\n', 'utf8');

  const rowNum = readRowNumber(out);
  if(!rowNum) die('Could not parse row_number from sheet_get_next_new output');

  // 2) generate markdown (needs tool.json)
  runInherit('node', ['scripts/generate_tool_md.mjs', TOOL_JSON]);
    }
// 5) finalize md
  runInherit('node', ['scripts/finalize_md.mjs', TOOL_JSON]);

  // 6) duplicate protection
    // cleanup stray empty markdown files (may appear after failed runs)
    try {
      const stray = '/opt/utildesk-motia/content/tools/.md';
      if (fs.existsSync(stray)) fs.unlinkSync(stray);
    } catch {}

  runInherit('node', ['scripts/check_duplicates.mjs']);

  // 7) set status DONE by row_number (real interface)
  runInherit('node', ['scripts/sheet_set_status.mjs', String(rowNum), 'DONE']);
}

console.log('\n[SUCCESS] Finished processing tools');
